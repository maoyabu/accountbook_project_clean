<% layout('layouts/boilerplate') %>
<div class="text-end mb-2">
  <a href="https://colts-wish-krs.craft.me/UJ4Y7muYdOwQlH/b/9FEF0134-024D-41B5-8B4D-44E9E627B86F/%E8%B3%87%E7%94%A3%E7%AE%A1%E7%90%86"
     target="_blank" rel="noopener"
     class="badge bg-success text-white text-decoration-none p-2">
    ガイド
  </a>
</div>
<div class="container mt-0">
  <% if (inventoryCallout) { %>
    <div class="alert alert-warning d-flex flex-column flex-lg-row justify-content-between align-items-lg-center">
      <div class="fw-bold mb-2 mb-lg-0">
        <%= inventoryCallout.label %>度の棚卸し実施時期です。棚卸しを実施してください。
      </div>
      <a href="/asset/inventory?month=<%= inventoryCallout.monthValue %>" class="btn btn-warning text-white">棚卸しに進む</a>
    </div>
  <% } %>

  <!-- 資産状況サマリー -->
  <div class="card shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between align-items-center text-white" style="background-color: #3a7ca5;">
      <span class="fw-bold">資産状況</span>
      <div class="d-flex gap-2">
        <a href="/asset" class="btn btn-warning btn-sm">登録・編集</a>
      </div>
    </div>
    <div class="card-body">
      <h4>資産合計　¥<%= totalYen.toLocaleString() %></h4>
      <table class="table borderless mt-3">
        <tr>
          <td>金融資産</td>
          <td class="text-end">¥<%= totalByCf['金融資産'].toLocaleString() %></td>
        </tr>
        <tr>
          <td>実物資産</td>
          <td class="text-end">¥<%= totalByCf['実物資産'].toLocaleString() %></td>
        </tr>
        <tr>
          <td>無形資産</td>
          <td class="text-end">¥<%= totalByCf['無形資産'].toLocaleString() %></td>
        </tr>
        <tr>
          <td>負債</td>
          <td class="text-end">¥<%= totalByCf['負債'].toLocaleString() %></td>
        </tr>
      </table>
    </div>
  </div>

  <!-- 資産明細 -->
  <div class="card shadow-sm mb-4">
    <div class="card-header text-white d-flex justify-content-between align-items-center" style="background-color: #3a7ca5;">
      <strong>資産明細</strong>
    </div>
    <table class="table table-bordered table-sm mb-0">
      <thead>
        <tr style="background-color: #3a7ca5;">
          <th>区分</th>
          <th>項目</th>
          <th>code</th>
          <th>内容</th>
          <th class="text-end">円換算金額</th>
        </tr>
      </thead>
      <tbody>
        <% assets.forEach(asset => { %>
          <tr>
            <td><%= asset.asset_cf %></td>
            <td><%= asset.asset_item %></td>
            <td><%= asset.code %></td>
            <td><%= asset.content %></td>
            <td class="text-end">¥<%= asset.amount.toLocaleString() %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <!-- 資産推移グラフ -->
  <div class="card shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between align-items-center text-white" style="background-color: #3a7ca5;">
      <strong>資産推移</strong>
      <a href="/asset/history" class="btn btn-outline-light btn-sm">棚卸し履歴</a>
    </div>
    <div class="card-body">
      <% const hasChart = (chartData.labels || []).length > 0; %>
      <% if (!hasChart) { %>
        <div class="alert alert-secondary mb-0">棚卸し履歴がありません。最新の棚卸しを登録してください。</div>
      <% } else { %>
        <canvas id="assetHistoryChart" height="140"></canvas>
      <% } %>
    </div>
  </div>

  <!-- レート情報 -->
  <div class="card mb-4">
    <div class="card-body text-muted small">
      <p>※ 円/＄レート（取得時点）: <%= exchangeRate %> 円</p>
      <% if (stockPrices) { %>
        <% Object.entries(stockPrices).forEach(([code, price]) => { %>
          <p>※ 株式 <%= code %>: 1株（前日終値） = <%= price.toLocaleString() %> 円</p>
        <% }) %>
      <% } %>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const chartData = <%- JSON.stringify(chartData || {}) %>;

  if (chartData.labels && chartData.labels.length) {
    const ctx = document.getElementById('assetHistoryChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: chartData.labels,
        datasets: [
          {
            label: '金融資産',
            data: chartData.series?.financial || [],
            backgroundColor: 'rgba(31, 119, 180, 0.65)',
            borderColor: '#1f77b4',
            stack: 'net'
          },
          {
            label: '実物資産',
            data: chartData.series?.physical || [],
            backgroundColor: 'rgba(44, 160, 44, 0.5)',
            borderColor: '#2ca02c',
            stack: 'net'
          },
          {
            label: '無形資産',
            data: chartData.series?.intangible || [],
            backgroundColor: 'rgba(255, 193, 7, 0.55)',
            borderColor: '#ffc107',
            stack: 'net'
          },
          {
            label: '負債',
            data: chartData.series?.debt || [],
            backgroundColor: 'rgba(220, 53, 69, 0.6)',
            borderColor: '#dc3545',
            stack: 'net'
          },
          {
            type: 'line',
            label: '合計',
            data: chartData.series?.total || [],
            borderColor: '#343a40',
            backgroundColor: '#343a40',
            tension: 0.2,
            pointRadius: 3,
            fill: false,
            yAxisID: 'y'
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { intersect: false, mode: 'index' },
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            callbacks: {
              label: (ctx) => `${ctx.dataset.label}: ¥${Number(ctx.raw || 0).toLocaleString()}`
            }
          }
        },
        scales: {
          y: {
            stacked: true,
            ticks: { callback: (value) => `¥${Number(value).toLocaleString()}` },
            beginAtZero: true
          },
          x: { stacked: true }
        }
      }
    });
  }
</script>
