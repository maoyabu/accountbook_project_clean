<% layout('layouts/boilerplate') %>

<div class="mt-3 mb-2 d-flex justify-content-between align-items-center">
  <div>
    <div class="small text-muted">
      <a href="/asset/display" class="text-decoration-none">資産管理トップ</a> ＞ 資産推移グラフ
    </div>
    <h5 class="mb-0">資産推移グラフ</h5>
  </div>
  <a href="/asset/history" class="btn btn-outline-secondary btn-sm">履歴一覧へ戻る</a>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <% const hasData = (JSON.parse(chartData || '{}').labels || []).length > 0; %>
    <% if (!hasData) { %>
      <div class="alert alert-secondary">グラフに表示するデータがありません。棚卸しを登録してください。</div>
    <% } else { %>
      <canvas id="assetHistoryChart" height="120"></canvas>
    <% } %>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const chartData = <%- chartData || '{}' %>;

  if (chartData.labels && chartData.labels.length > 0) {
    const ctx = document.getElementById('assetHistoryChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: chartData.labels,
        datasets: [
          {
            label: '金融資産',
            data: chartData.series?.financial || [],
            backgroundColor: 'rgba(31, 119, 180, 0.65)',
            borderColor: '#1f77b4',
            stack: 'net'
          },
          {
            label: '実物資産',
            data: chartData.series?.physical || [],
            backgroundColor: 'rgba(44, 160, 44, 0.5)',
            borderColor: '#2ca02c',
            stack: 'net'
          },
          {
            label: '無形資産',
            data: chartData.series?.intangible || [],
            backgroundColor: 'rgba(255, 193, 7, 0.55)',
            borderColor: '#ffc107',
            stack: 'net'
          },
          {
            label: '負債',
            data: chartData.series?.debt || [],
            backgroundColor: 'rgba(220, 53, 69, 0.6)',
            borderColor: '#dc3545',
            stack: 'net'
          },
          {
            type: 'line',
            label: '合計',
            data: chartData.series?.total || [],
            borderColor: '#343a40',
            backgroundColor: '#343a40',
            tension: 0.2,
            pointRadius: 3,
            fill: false,
            yAxisID: 'y'
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { intersect: false, mode: 'index' },
        plugins: {
          legend: {
            position: 'top'
          },
          tooltip: {
            callbacks: {
              label: (ctx) => `${ctx.dataset.label}: ¥${Number(ctx.raw || 0).toLocaleString()}`
            }
          }
        },
        scales: {
          y: {
            ticks: {
              callback: (value) => `¥${Number(value).toLocaleString()}`
            },
            beginAtZero: true,
            stacked: true
          },
          x: {
            stacked: true
          }
        }
      }
    });
  }
</script>
