<% layout('layouts/boilerplate') %>
<div class="text-end">
  <a href="https://colts-wish-krs.craft.me/UJ4Y7muYdOwQlH/b/9FEF0134-024D-41B5-8B4D-44E9E627B86F/%E8%B3%87%E7%94%A3%E7%AE%A1%E7%90%86"
     target="_blank" rel="noopener"
     class="badge bg-success text-white text-decoration-none p-2">
    ã‚¬ã‚¤ãƒ‰
  </a>
</div>
<div class="card shadow-sm mt-2">
  <div class="card-header text-white" style="background-color: #3a7ca5;">
    <h5 class="mb-0"><%= editAsset ? "è³‡ç”£ã‚’ç·¨é›†" : "è³‡ç”£ã‚’ç™»éŒ²" %></h5>
  </div>
  <div class="card-body">
    <% if (typeof latestInventory !== 'undefined' && latestInventory) { %>
      <div class="alert alert-info py-2">
        æœ€çµ‚æ£šå¸ã—ï¼š<%= latestInventory.inventoryMonth.getFullYear() %>å¹´<%= String(latestInventory.inventoryMonth.getMonth() + 1).padStart(2, '0') %>æœˆ
        ï¼ˆæ›´æ–°æ—¥æ™‚: <%= latestInventory.updatedAt ? new Date(latestInventory.updatedAt).toLocaleString('ja-JP') : '-' %>ï¼‰
        <span class="ms-2"><a href="/asset/history" class="text-decoration-underline">å±¥æ­´ã‚’ç¢ºèª</a></span>
      </div>
    <% } %>
    <form action="<%= editAsset ? '/asset/update/' + editAsset._id : '/asset/create' %>" method="POST">
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="asset_cf">è³‡ç”£åŒºåˆ†<span style="color: red;">ï¼ˆ*å¿…é ˆï¼‰</span></label>
          <select name="asset_cf" id="asset_cf" class="form-control" required>
            <% asset_cfs.forEach(item => { %>
              <option value="<%= item %>" <%= editAsset && editAsset.asset_cf === item ? 'selected' : '' %>><%= item %></option>
            <% }) %>
          </select>
        </div>
        <div class="col-md-5 category-group" id="current_asset_group" style="display:none;">
          <label>é‡‘èè³‡ç”£å†…å®¹<span style="color: red;">ï¼ˆ*å¿…é ˆï¼‰</span></label>
          <select name="asset_item" class="form-control">
            <% current_assets.forEach(item => { %>
              <option value="<%= item %>" <%= editAsset && editAsset.asset_item === item ? 'selected' : '' %>><%= item %></option>
            <% }) %>
          </select>
        </div>
        <div class="col-md-5 category-group" id="fixed_asset_group" style="display:none;">
          <label>å®Ÿç‰©è³‡ç”£å†…å®¹<span style="color: red;">ï¼ˆ*å¿…é ˆï¼‰</span></label>
          <select name="asset_item" class="form-control">
            <% fixed_assets.forEach(item => { %>
              <option value="<%= item %>" <%= editAsset && editAsset.asset_item === item ? 'selected' : '' %>><%= item %></option>
            <% }) %>
          </select>
        </div>
        <div class="col-md-5 category-group" id="intangible_asset_group" style="display:none;">
          <label>ç„¡å½¢è³‡ç”£å†…å®¹<span style="color: red;">ï¼ˆ*å¿…é ˆï¼‰</span></label>
          <select name="asset_item" class="form-control">
            <% intangible_assets.forEach(item => { %>
              <option value="<%= item %>" <%= editAsset && editAsset.asset_item === item ? 'selected' : '' %>><%= item %></option>
            <% }) %>
          </select>
        </div>
        <div class="col-md-5 category-group" id="debt_group" style="display:none;">
          <label>è² å‚µå†…å®¹<span style="color: red;">ï¼ˆ*å¿…é ˆï¼‰</span></label>
          <select name="asset_item" class="form-control">
            <% ['Please Choice','ä½å®…ãƒ­ãƒ¼ãƒ³','è‡ªå‹•è»Šãƒ­ãƒ¼ãƒ³','ãã®ä»–ãƒ­ãƒ¼ãƒ³','ãã®ä»–è² å‚µ'].forEach(item => { %>
              <option value="<%= item %>" <%= editAsset && editAsset.asset_item === item ? 'selected' : '' %>><%= item %></option>
            <% }) %>
          </select>
        </div>
      </div>
      <div class="col-md-3">
        <label for="code">ã‚³ãƒ¼ãƒ‰ï¼ˆæ ªå¼ã®å ´åˆï¼šè¨¼åˆ¸ã‚³ãƒ¼ãƒ‰ã€ç‚ºæ›¿ã®å ´åˆï¼„ãªã‚‰$ï¼‰</label>
        <input type="text" name="code" class="form-control" value="<%= editAsset ? editAsset.code : '' %>">
      </div>
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="content">è³‡ç”£å†…å®¹<span style="color: red;">ï¼ˆ*å¿…é ˆï¼‰</span></label>
          <textarea name="content" class="form-control" required><%= editAsset ? editAsset.content : '' %></textarea>
        </div>
        <div class="col-md-3">
          <label for="amount">æ•°é‡<span style="color: red;">ï¼ˆ*å¿…é ˆï¼‰</span></label>
          <input type="number" name="amount" class="form-control" required value="<%= editAsset ? editAsset.amount : '' %>">
        </div>
        <div class="col-md-3">
          <label for="monetary_unit">å˜ä½<span style="color: red;">ï¼ˆ*å¿…é ˆï¼‰</span></label>
          <select name="monetary_unit" class="form-control" required>
            <% monetary_units.forEach(unit => { %>
              <option value="<%= unit %>" <%= editAsset && editAsset.monetary_unit === unit ? 'selected' : '' %>><%= unit %></option>
            <% }) %>
          </select>
        </div>
        <small class="form-text text-muted">â€» è² å‚µã®å ´åˆã¯ãƒã‚¤ãƒŠã‚¹ã®é‡‘é¡ï¼ˆä¾‹ï¼š-3000000ï¼‰ã§å…¥åŠ›ã—ã¦ãã ã•ã„</small>
      </div>

      <!-- Secure Note Authentication Button and Password Input -->
      <div class="row mb-3">
        <div class="col-md-12 text-end">
          <button type="button" class="btn btn-outline-secondary btn-sm" id="unlockSecureNoteBtn">
            ğŸ” æ©Ÿå¯†æƒ…å ±ã‚’è¡¨ç¤ºãƒ»ç·¨é›†ã™ã‚‹
          </button>
        </div>
      </div>
      <div class="row mb-3" id="secureNoteAuthSection" style="display: none;">
        <div class="col-md-6">
          <input type="password" id="secureNotePassword" name="password" class="form-control" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
        </div>
        <div class="col-md-6">
          <button type="button" class="btn btn-primary" id="verifySecureNoteBtn">èªè¨¼</button>
        </div>
      </div>
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          const unlockBtn = document.getElementById("unlockSecureNoteBtn");
          const authSection = document.getElementById("secureNoteAuthSection");
          const verifyBtn = document.getElementById("verifySecureNoteBtn");
          const passwordInput = document.getElementById("secureNotePassword");

          unlockBtn.addEventListener("click", function () {
            authSection.style.display = "flex";
          });

          verifyBtn.addEventListener("click", async function () {
            const password = passwordInput.value.trim();
            const secureNoteField = document.querySelector('textarea[name="secure_note"]');
            const assetId = "<%= editAsset ? editAsset._id : '' %>";

            // console.log("Password:", password);
            // console.log("Asset ID:", assetId);

            if (!password) {
              alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
              return;
            }

            if (!assetId) {
              alert("è³‡ç”£IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®ã¿å¯¾å¿œï¼‰");
              return;
            }

            try {
              const res = await fetch(`/secure-note/${assetId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ password })
              });

              const result = await res.json();
              // console.log("Response:", result);

              if (res.ok) {
                secureNoteField.value = result.secure_note;
                secureNoteField.removeAttribute("disabled");
                authSection.style.display = "none";
                unlockBtn.style.display = "none";
              } else {
                alert(result.error || "èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
              }
            } catch (err) {
              console.error("Fetch error:", err);
              alert("å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            }
          });
        });
      </script>
      <div class="row mb-3">
        <div class="col-md-12">
          <label for="secure_note">æ©Ÿå¯†æƒ…å ±ï¼ˆå£åº§æƒ…å ±ãªã©ï¼‰</label>
          <textarea name="secure_note" class="form-control" rows="3" placeholder="â€»è¡¨ç¤ºãƒ»ç·¨é›†ã«ã¯åˆ¥é€”ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ãŒå¿…è¦ã§ã™" <%= editAsset && editAsset.secure_note ? '' : 'disabled' %>><%= editAsset && editAsset.secure_note ? editAsset.secure_note : (editAsset ? 'ğŸ”’ ã‚»ã‚­ãƒ¥ã‚¢æƒ…å ±ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã§å–å¾—' : '') %></textarea>
          <small class="form-text text-muted">â€» ç™»éŒ²å¾Œã®è¡¨ç¤ºãƒ»ç·¨é›†ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†èªè¨¼ãŒå¿…è¦ã§ã™</small>
        </div>
      </div>
      <div class="text-center">
        <button type="submit" class="btn btn-primary btn-ig" style="width: 60%;"><%= editAsset ? "æ›´æ–°ã™ã‚‹" : "è³‡ç”£ã‚’ç™»éŒ²" %></button>
      </div>
    </form>
  </div>
</div>

<div class="container mt-4">
  <div class="card shadow-sm mb-4">
    <div class="card-header text-white" style="background-color: #3a7ca5;">
      <h5 class="mb-0">ç™»éŒ²æ¸ˆã¿è³‡ç”£ä¸€è¦§</h5>
    </div>
    <div class="card-body">
      <% if (assets.length === 0) { %>
        <p>ç¾åœ¨ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹è³‡ç”£ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      <% } else { %>
        <table class="table table-bordered table-sm">
          <thead>
            <tr>
              <th>åŒºåˆ†</th>
              <th>é …ç›®</th>
              <th>code</th>
              <th>å†…å®¹</th>
              <th>æ•°é‡</th>
              <th>å˜ä½</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            <% assets.forEach(asset => { %>
              <tr>
                <td><%= asset.asset_cf %></td>
                <td><%= asset.asset_item %></td>
                <td><%= asset.code %></td>
                <td><%= asset.content %></td>
                <td class="text-end"><%= asset.amount.toLocaleString() %></td>
                <td><%= asset.monetary_unit %></td>
                <td class="d-flex gap-1">
                  <a href="/asset/edit/<%= asset._id %>" class="btn btn-warning btn-sm"><i class="fas fa-edit"></i></a>
                  <form action="/asset/<%= asset._id %>?_method=DELETE" method="POST" onsubmit="return confirm('å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')">
                    <button type="submit" class="btn btn-danger btn-sm"><i class="fas fa-trash-alt"></i></button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } %>
    </div>
  </div>
  <div class="text-center mb-5">
    <div class="d-grid gap-2 col-lg-6 mx-auto">
      <a href="/asset/display" class="btn btn-success btn-lg">è³‡ç”£çŠ¶æ³</a>
      <a href="/asset/inventory" class="btn btn-outline-primary">æ£šå¸ã—å…¥åŠ›</a>
      <a href="/asset/history" class="btn btn-outline-secondary">æ£šå¸ã—å±¥æ­´</a>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const cfSelect = document.getElementById("asset_cf");
    const currentAssetGroup = document.getElementById("current_asset_group");
    const fixedAssetGroup = document.getElementById("fixed_asset_group");
    const intangibleAssetGroup = document.getElementById("intangible_asset_group");
    const debtGroup = document.getElementById("debt_group");
    const debts = ['Please Choice','ä½å®…ãƒ­ãƒ¼ãƒ³','è‡ªå‹•è»Šãƒ­ãƒ¼ãƒ³','ãã®ä»–ãƒ­ãƒ¼ãƒ³','ãã®ä»–è² å‚µ']; // â†ãƒ“ãƒ¥ãƒ¼ã§ã‚‚å®šç¾©

    const selects = currentAssetGroup.querySelectorAll('select, input');
    const fixedSelects = fixedAssetGroup.querySelectorAll('select, input');
    const intangibleSelects = intangibleAssetGroup.querySelectorAll('select, input');
    const debtSelects = debtGroup.querySelectorAll('select, input');

    function toggleCategory() {
      currentAssetGroup.style.display = "none";
      fixedAssetGroup.style.display = "none";
      intangibleAssetGroup.style.display = "none";
      debtGroup.style.display = "none";
      selects.forEach(s => s.disabled = true);
      fixedSelects.forEach(s => s.disabled = true);
      intangibleSelects.forEach(s => s.disabled = true);
      debtSelects.forEach(s => s.disabled = true);

      if (cfSelect.value === "é‡‘èè³‡ç”£") {
        currentAssetGroup.style.display = "block";
        selects.forEach(s => s.disabled = false);
      } else if (cfSelect.value === "å®Ÿç‰©è³‡ç”£") {
        fixedAssetGroup.style.display = "block";
        fixedSelects.forEach(s => s.disabled = false);
      } else if (cfSelect.value === "ç„¡å½¢è³‡ç”£") {
        intangibleAssetGroup.style.display = "block";
        intangibleSelects.forEach(s => s.disabled = false);
      } else if (cfSelect.value === "è² å‚µ") {
        debtGroup.style.display = "block";
        debtSelects.forEach(s => s.disabled = false);
      }
    }

    cfSelect.addEventListener("change", toggleCategory);
    toggleCategory();
  });
</script>
