<% layout('layouts/boilerplate') %>
<div class="d-flex justify-content-between align-items-center">
  <div class="small text-muted">
    <a href="/asset/display" class="text-decoration-none">è³‡ç”£ç®¡ç†ãƒˆãƒƒãƒ—</a> ï¼ è³‡ç”£ã®ç™»éŒ²ãƒ»ç·¨é›†
  </div>
  <a href="https://colts-wish-krs.craft.me/UJ4Y7muYdOwQlH/b/9FEF0134-024D-41B5-8B4D-44E9E627B86F/%E8%B3%87%E7%94%A3%E7%AE%A1%E7%90%86"
     target="_blank" rel="noopener"
     class="badge bg-success text-white text-decoration-none p-2 ms-auto">
    ã‚¬ã‚¤ãƒ‰
  </a>
</div>

<div class="card shadow-sm mt-2">
  <div class="card-header d-flex justify-content-between align-items-center text-white" style="background-color: #3a7ca5;">
    <h5 class="mb-0">è³‡ç”£ã®ç™»éŒ²ãƒ»ç·¨é›†</h5>
    <div class="d-flex gap-2">
      <a href="/asset/display" class="btn btn-light btn-sm">è³‡ç”£çŠ¶æ³</a>
    </div>
  </div>
  <div class="card-body">
    <% if (typeof latestInventory !== 'undefined' && latestInventory) { %>
      <div class="alert alert-info py-2">
        æœ€çµ‚æ£šå¸ã—ï¼š<%= latestInventory.inventoryMonth.getFullYear() %>å¹´<%= String(latestInventory.inventoryMonth.getMonth() + 1).padStart(2, '0') %>æœˆ
        ï¼ˆæ›´æ–°æ—¥æ™‚: <%= latestInventory.updatedAt ? new Date(latestInventory.updatedAt).toLocaleString('ja-JP') : '-' %>ï¼‰
        <span class="ms-2"><a href="/asset/history" class="text-decoration-underline">å±¥æ­´ã‚’ç¢ºèª</a></span>
      </div>
    <% } %>

    <div class="d-flex justify-content-start align-items-center mb-3">
      <button class="btn btn-primary btn-sm" id="newAssetBtn">è³‡ç”£ã‚’æ–°è¦è¿½åŠ </button>
      <h6 class="mb-0 text-muted ms-3">ç™»éŒ²ãƒ»ç·¨é›†ã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰è¡Œã„ã¾ã™</h6>
    </div>

    <% if (assets.length === 0) { %>
      <p class="text-muted">ç¾åœ¨ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹è³‡ç”£ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<button type="button" class="btn btn-link p-0 align-baseline" id="newAssetInline">ã“ã¡ã‚‰ã‹ã‚‰ç™»éŒ²</button></p>
    <% } else { %>
      <div class="table-responsive">
        <table class="table table-bordered table-sm align-middle">
          <thead style="background-color: #3a7ca5;" class="text-white">
            <tr>
              <th class="text-center align-middle">åŒºåˆ†</th>
              <th class="text-center align-middle">é …ç›®</th>
              <th class="text-center align-middle">code</th>
              <th class="text-center align-middle">å†…å®¹</th>
              <th class="text-center align-middle">æ•°é‡</th>
              <th class="text-center align-middle">å˜ä½</th>
              <th class="text-center align-middle">ç™»éŒ²</th>
              <th class="text-center align-middle">æ›´æ–°</th>
              <th class="text-center align-middle" style="width: 120px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            <% assets.forEach(asset => { 
              const assetPayload = {
                id: asset._id,
                asset_cf: asset.asset_cf,
                asset_item: asset.asset_item,
                code: asset.code || '',
                content: asset.content || '',
                amount: asset.amount,
                monetary_unit: asset.monetary_unit
              };
            %>
              <tr>
                <td><%= asset.asset_cf %></td>
                <td><%= asset.asset_item %></td>
                <td><%= asset.code %></td>
                <td><%= asset.content %></td>
                <td class="text-end"><%= asset.amount.toLocaleString() %></td>
                <td><%= asset.monetary_unit %></td>
                <td class="small">
                  <div><%= asset.createdBy?.displayname || asset.createdBy?.username || 'è¨˜éŒ²ãªã—' %></div>
                  <div class="text-muted"><%= asset.entry_date ? new Date(asset.entry_date).toLocaleString('ja-JP') : '-' %></div>
                </td>
                <td class="small">
                  <div><%= asset.updatedBy?.displayname || asset.updatedBy?.username || 'è¨˜éŒ²ãªã—' %></div>
                  <div class="text-muted"><%= asset.update_date ? new Date(asset.update_date).toLocaleString('ja-JP') : '-' %></div>
                </td>
                <td class="d-flex gap-1">
                  <button
                    type="button"
                    class="btn btn-warning btn-sm edit-asset-btn"
                    data-id="<%= asset._id %>"
                    data-asset='<%- JSON.stringify(assetPayload).replace(/'/g, '&#39;') %>'>
                    <i class="fas fa-edit"></i>
                  </button>
                  <form action="/asset/<%= asset._id %>?_method=DELETE" method="POST" onsubmit="return confirm('å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')">
                    <button type="submit" class="btn btn-danger btn-sm"><i class="fas fa-trash-alt"></i></button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } %>
  </div>
</div>

<!-- Asset Modal -->
<div class="modal fade" id="assetModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="assetModalLabel">è³‡ç”£ã‚’ç™»éŒ²</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="assetForm" action="/asset/create" method="POST">
        <div class="modal-body">
          <input type="hidden" id="assetIdField">
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="asset_cf">è³‡ç”£åŒºåˆ†<span style="color: red;">ï¼ˆ*å¿…é ˆï¼‰</span></label>
              <select name="asset_cf" id="asset_cf" class="form-control" required>
                <% asset_cfs.forEach(item => { %>
                  <option value="<%= item %>"><%= item %></option>
                <% }) %>
              </select>
            </div>
            <div class="col-md-5 category-group" id="current_asset_group" style="display:none;">
              <label>é‡‘èè³‡ç”£å†…å®¹<span style="color: red;">ï¼ˆ*å¿…é ˆï¼‰</span></label>
              <select name="asset_item" id="asset_item_current" class="form-control">
                <% current_assets.forEach(item => { %>
                  <option value="<%= item %>"><%= item %></option>
                <% }) %>
              </select>
            </div>
            <div class="col-md-5 category-group" id="fixed_asset_group" style="display:none;">
              <label>å®Ÿç‰©è³‡ç”£å†…å®¹<span style="color: red;">ï¼ˆ*å¿…é ˆï¼‰</span></label>
              <select name="asset_item" id="asset_item_fixed" class="form-control">
                <% fixed_assets.forEach(item => { %>
                  <option value="<%= item %>"><%= item %></option>
                <% }) %>
              </select>
            </div>
            <div class="col-md-5 category-group" id="intangible_asset_group" style="display:none;">
              <label>ç„¡å½¢è³‡ç”£å†…å®¹<span style="color: red;">ï¼ˆ*å¿…é ˆï¼‰</span></label>
              <select name="asset_item" id="asset_item_intangible" class="form-control">
                <% intangible_assets.forEach(item => { %>
                  <option value="<%= item %>"><%= item %></option>
                <% }) %>
              </select>
            </div>
            <div class="col-md-5 category-group" id="debt_group" style="display:none;">
              <label>è² å‚µå†…å®¹<span style="color: red;">ï¼ˆ*å¿…é ˆï¼‰</span></label>
              <select name="asset_item" id="asset_item_debt" class="form-control">
                <% ['Please Choice','ä½å®…ãƒ­ãƒ¼ãƒ³','è‡ªå‹•è»Šãƒ­ãƒ¼ãƒ³','ãã®ä»–ãƒ­ãƒ¼ãƒ³','ãã®ä»–è² å‚µ'].forEach(item => { %>
                  <option value="<%= item %>"><%= item %></option>
                <% }) %>
              </select>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="code">ã‚³ãƒ¼ãƒ‰ï¼ˆæ ªå¼ã®å ´åˆï¼šè¨¼åˆ¸ã‚³ãƒ¼ãƒ‰ã€ç‚ºæ›¿ã®å ´åˆï¼„ãªã‚‰$ï¼‰</label>
              <input type="text" name="code" id="code" class="form-control">
            </div>
            <div class="col-md-5">
              <label for="content">è³‡ç”£å†…å®¹<span style="color: red;">ï¼ˆ*å¿…é ˆï¼‰</span></label>
              <textarea name="content" id="content" class="form-control" required></textarea>
            </div>
            <div class="col-md-3">
              <label for="amount">æ•°é‡<span style="color: red;">ï¼ˆ*å¿…é ˆï¼‰</span></label>
              <input type="number" name="amount" id="amount" class="form-control" required>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="monetary_unit">å˜ä½<span style="color: red;">ï¼ˆ*å¿…é ˆï¼‰</span></label>
              <select name="monetary_unit" id="monetary_unit" class="form-control" required>
                <% monetary_units.forEach(unit => { %>
                  <option value="<%= unit %>"><%= unit %></option>
                <% }) %>
              </select>
            </div>
            <div class="col-md-8 d-flex align-items-end">
              <small class="form-text text-muted">â€» è² å‚µã®å ´åˆã¯ãƒã‚¤ãƒŠã‚¹ã®é‡‘é¡ï¼ˆä¾‹ï¼š-3000000ï¼‰ã§å…¥åŠ›ã—ã¦ãã ã•ã„</small>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-12 text-end">
              <button type="button" class="btn btn-outline-secondary btn-sm" id="unlockSecureNoteBtn">
                ğŸ” æ©Ÿå¯†æƒ…å ±ã‚’è¡¨ç¤ºãƒ»ç·¨é›†ã™ã‚‹
              </button>
            </div>
          </div>
          <div class="row mb-3" id="secureNoteAuthSection" style="display: none;">
            <div class="col-md-6">
              <input type="password" id="secureNotePassword" name="password" class="form-control" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
            </div>
            <div class="col-md-6">
              <button type="button" class="btn btn-primary" id="verifySecureNoteBtn">èªè¨¼</button>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-12">
              <label for="secure_note">æ©Ÿå¯†æƒ…å ±ï¼ˆå£åº§æƒ…å ±ãªã©ï¼‰</label>
              <textarea name="secure_note" id="secure_note" class="form-control" rows="3" placeholder="â€»ç·¨é›†æ™‚ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ãŒå¿…è¦ã§ã™" disabled></textarea>
              <small class="form-text text-muted">â€» ç™»éŒ²å¾Œã®è¡¨ç¤ºãƒ»ç·¨é›†ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†èªè¨¼ãŒå¿…è¦ã§ã™</small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
          <button type="submit" class="btn btn-primary">ä¿å­˜ã™ã‚‹</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const cfSelect = document.getElementById("asset_cf");
    const currentAssetGroup = document.getElementById("current_asset_group");
    const fixedAssetGroup = document.getElementById("fixed_asset_group");
    const intangibleAssetGroup = document.getElementById("intangible_asset_group");
    const debtGroup = document.getElementById("debt_group");
    const assetModal = new bootstrap.Modal(document.getElementById('assetModal'));
    const modalTitle = document.getElementById('assetModalLabel');
    const assetForm = document.getElementById('assetForm');
    const newAssetBtn = document.getElementById('newAssetBtn');
    const newAssetInline = document.getElementById('newAssetInline');
    const unlockBtn = document.getElementById("unlockSecureNoteBtn");
    const authSection = document.getElementById("secureNoteAuthSection");
    const verifyBtn = document.getElementById("verifySecureNoteBtn");
    const passwordInput = document.getElementById("secureNotePassword");
    const secureNoteField = document.getElementById("secure_note");
    const assetIdField = document.getElementById("assetIdField");
    let editingAssetId = null;

    const selects = currentAssetGroup.querySelectorAll('select, input');
    const fixedSelects = fixedAssetGroup.querySelectorAll('select, input');
    const intangibleSelects = intangibleAssetGroup.querySelectorAll('select, input');
    const debtSelects = debtGroup.querySelectorAll('select, input');

    function toggleCategory() {
      currentAssetGroup.style.display = "none";
      fixedAssetGroup.style.display = "none";
      intangibleAssetGroup.style.display = "none";
      debtGroup.style.display = "none";
      selects.forEach(s => s.disabled = true);
      fixedSelects.forEach(s => s.disabled = true);
      intangibleSelects.forEach(s => s.disabled = true);
      debtSelects.forEach(s => s.disabled = true);

      if (cfSelect.value === "é‡‘èè³‡ç”£") {
        currentAssetGroup.style.display = "block";
        selects.forEach(s => s.disabled = false);
      } else if (cfSelect.value === "å®Ÿç‰©è³‡ç”£") {
        fixedAssetGroup.style.display = "block";
        fixedSelects.forEach(s => s.disabled = false);
      } else if (cfSelect.value === "ç„¡å½¢è³‡ç”£") {
        intangibleAssetGroup.style.display = "block";
        intangibleSelects.forEach(s => s.disabled = false);
      } else if (cfSelect.value === "è² å‚µ") {
        debtGroup.style.display = "block";
        debtSelects.forEach(s => s.disabled = false);
      }
    }

    function fillForm(asset) {
      assetForm.reset();
      authSection.style.display = "none";
      passwordInput.value = '';
      secureNoteField.value = '';
      secureNoteField.setAttribute("disabled", "disabled");
      unlockBtn.style.display = "inline-block";
      editingAssetId = asset?.id || null;

      if (!asset) {
        modalTitle.textContent = "è³‡ç”£ã‚’ç™»éŒ²";
        assetForm.action = "/asset/create";
        cfSelect.value = cfSelect.options[0]?.value || '';
        toggleCategory();
        // æ–°è¦ã¯ã‚»ã‚­ãƒ¥ã‚¢æƒ…å ±ãªã—
        unlockBtn.style.display = "none";
        return;
      }

      modalTitle.textContent = "è³‡ç”£ã‚’ç·¨é›†";
      assetForm.action = `/asset/update/${asset.id}`;
      assetIdField.value = asset.id;
      document.getElementById('code').value = asset.code || '';
      document.getElementById('content').value = asset.content || '';
      document.getElementById('amount').value = asset.amount || 0;
      document.getElementById('monetary_unit').value = asset.monetary_unit || '';
      cfSelect.value = asset.asset_cf || '';

      toggleCategory();
      if (asset.asset_cf === "é‡‘èè³‡ç”£") {
        document.getElementById('asset_item_current').value = asset.asset_item || '';
      } else if (asset.asset_cf === "å®Ÿç‰©è³‡ç”£") {
        document.getElementById('asset_item_fixed').value = asset.asset_item || '';
      } else if (asset.asset_cf === "ç„¡å½¢è³‡ç”£") {
        document.getElementById('asset_item_intangible').value = asset.asset_item || '';
      } else if (asset.asset_cf === "è² å‚µ") {
        document.getElementById('asset_item_debt').value = asset.asset_item || '';
      }

      secureNoteField.value = "ğŸ”’ ã‚»ã‚­ãƒ¥ã‚¢æƒ…å ±ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã§å–å¾—";
    }

    cfSelect.addEventListener("change", toggleCategory);
    toggleCategory();

    newAssetBtn.addEventListener("click", () => {
      fillForm(null);
      assetModal.show();
    });
    if (newAssetInline) {
      newAssetInline.addEventListener("click", (e) => {
        e.preventDefault();
        fillForm(null);
        assetModal.show();
      });
    }

    document.querySelectorAll('.edit-asset-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const asset = JSON.parse(btn.dataset.asset);
        fillForm(asset);
        assetModal.show();
      });
    });

    unlockBtn.addEventListener("click", function () {
      authSection.style.display = "flex";
    });

    verifyBtn.addEventListener("click", async function () {
      const password = passwordInput.value.trim();

      if (!password) {
        alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      if (!editingAssetId) {
        alert("è³‡ç”£IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®ã¿å¯¾å¿œï¼‰");
        return;
      }

      try {
        const res = await fetch(`/secure-note/${editingAssetId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password })
        });

        const result = await res.json();

        if (res.ok) {
          secureNoteField.value = result.secure_note;
          secureNoteField.removeAttribute("disabled");
          authSection.style.display = "none";
          unlockBtn.style.display = "none";
        } else {
          alert(result.error || "èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
      } catch (err) {
        console.error("Fetch error:", err);
        alert("å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      }
    });

    // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆdisplayã‹ã‚‰ã®å°ç·šç”¨ï¼‰
    const params = new URLSearchParams(window.location.search);
    if (params.get('open') === 'create') {
      fillForm(null);
      assetModal.show();
    } else if (params.get('assetId')) {
      const btn = document.querySelector(`.edit-asset-btn[data-id="${params.get('assetId')}"]`);
      if (btn) {
        btn.click();
      }
    }
  });
</script>
