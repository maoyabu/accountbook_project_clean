<% layout('layouts/boilerplate') %>

<head>
  <meta charset="UTF-8">
  <title>月別支出項目別（積み上げ棒グラフ）</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  
</head>
<body>
  <div class="mt-4">
    <form method="get" action="/export/monthly-stacked" id="filterForm" class="row align-items-center">
      <div class="col-md-12 d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">【月別支出項目別グラフ】</h3>
        <div>
          <label for="yearSelector" class="form-label me-2 mb-0">年を選択:</label>
          <select id="yearSelector" name="year" class="form-select d-inline-block w-auto">
            <% availableYears.forEach(y => { %>
              <option value="<%= y %>" <%= y === year ? 'selected' : '' %>><%= y %>年</option>
            <% }) %>
          </select>
        </div>
      </div>
      <hr>
      <div class="col-md-12">
        <div style="width:100%;">
          <canvas id="stackedBarChart" height="300"></canvas>
        </div>
      </div>
    </form>
  </div>
  <script>
    const rawDatasets = <%- JSON.stringify(datasets) %>;

    const ctx = document.getElementById('stackedBarChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: <%- JSON.stringify(labels) %>,
        datasets: rawDatasets
      },
      options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: '月別支出項目別（積み上げ）'
            },
            legend: {
                position: 'bottom'
            },
            datalabels: {
                formatter: (value, context) => {
                const datasetIndex = context.datasetIndex;
                const dataIndex = context.dataIndex;
                const datasets = context.chart.data.datasets;
                
                let total = 0;
                datasets.forEach(ds => {
                    total += ds.data[dataIndex] || 0;
                });

                const percentage = total ? (value / total) * 100 : 0;
                return percentage.toFixed(1) + '%';
                },
                color: '#fff',
                font: {
                weight: 'bold'
                }
            }
        },
        scales: {
          x: {
            stacked: true
          },
          y: {
            stacked: true
          }
        }
      },
      plugins: [ChartDataLabels]
    });

    document.getElementById('yearSelector').addEventListener('change', () => {
      document.getElementById('filterForm').submit();
    });
  </script>
</body>
