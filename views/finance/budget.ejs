<% layout('layouts/boilerplate') %>
  <div class="text-end mb-2">
    <a href="https://colts-wish-krs.craft.me/UJ4Y7muYdOwQlH/b/1E4B2174-E5D2-44AD-A003-E17BAC4C2917/%E5%AE%B6%E8%A8%88%E7%B0%BF%E3%81%AE%E5%88%9D%E6%9C%9F%E8%A8%AD%E5%AE%9A"
      target="_blank" rel="noopener"
      class="badge bg-success text-white text-decoration-none p-2">
      ガイド
    </a>
  </div>
  <div class="card-header text-white mt-2 mb-0" style="background-color: #3a7ca5;"><i class="fa-regular fa-money-bill-1"></i> 収入・控除・貯蓄の項目と予算の設定</div>
  <div class="p-3 border rounded bg-light mt-0">
    <form id="budgetForm" action="/finance/budget/save" method="POST">
      <input type="hidden" name="groupId" value="<%= groupId %>">
      <input type="hidden" name="year" value="<%= year %>">
      <!-- 収入項目 -->
      <h6 class="mt-1"><strong>収入項目</strong></h6>
      <table class="table table-bordered">
        <thead>
                    <tr><th>表示順</th><th>項目名</th><th>予算額</th><th>操作</th></tr>
        </thead>
        <tbody id="incomeItemsTableBody">
          <% incomeItems.forEach((item, idx) => { %>
            <tr>
              <td><input type="number" name="incomeItems[<%= idx %>][display_order]" value="<%= item.display_order %>" class="form-control" required></td>
              <td><input type="text" name="incomeItems[<%= idx %>][item]" value="<%= item.item %>" class="form-control" required></td>
              <td><input type="number" name="incomeItems[<%= idx %>][budget]" value="<%= item.budget %>" class="form-control" required></td>
              <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)"><i class="fas fa-trash-alt"></i></button></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
            <button type="button" class="btn btn-secondary btn-sm" onclick="addRowTo('incomeItems')">＋項目追加</button>
      <!-- 控除項目 -->
      <h6 class="mt-4"><strong>控除項目</strong></h6>
      <table class="table table-bordered">
        <thead>
                    <tr><th>表示順</th><th>項目名</th><th>予算額</th><th>操作</th></tr>
        </thead>
        <tbody id="deduItemsTableBody">
          <% deduItems.forEach((item, idx) => { %>
            <tr>
              <td><input type="number" name="deduItems[<%= idx %>][display_order]" value="<%= item.display_order %>" class="form-control" required></td>
              <td><input type="text" name="deduItems[<%= idx %>][item]" value="<%= item.item %>" class="form-control" required></td>
              <td><input type="number" name="deduItems[<%= idx %>][budget]" value="<%= item.budget %>" class="form-control" required></td>
              <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)"><i class="fas fa-trash-alt"></i></button></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
            <button type="button" class="btn btn-secondary btn-sm" onclick="addRowTo('deduItems')">＋項目追加</button>
      <!-- 貯蓄項目 -->
      <h6 class="mt-4"><strong>貯蓄項目</strong></h6>
      <table class="table table-bordered">
        <thead>
                    <tr><th>表示順</th><th>項目名</th><th>予算額</th><th>操作</th></tr>
        </thead>
        <tbody id="savingItemsTableBody">
          <% savingItems.forEach((item, idx) => { %>
            <tr>
              <td><input type="number" name="savingItems[<%= idx %>][display_order]" value="<%= item.display_order %>" class="form-control" required></td>
              <td><input type="text" name="savingItems[<%= idx %>][item]" value="<%= item.item %>" class="form-control" required></td>
              <td><input type="number" name="savingItems[<%= idx %>][budget]" value="<%= item.budget %>" class="form-control" required></td>
              <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)"><i class="fas fa-trash-alt"></i></button></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
                <button type="button" class="btn btn-secondary btn-sm" onclick="addRowTo('savingItems')">＋項目追加</button>
      <!-- 支出項目 -->
      <div class="mt-4"><strong>支出の項目と予算の設定</strong></div>
      <table class="table table-bordered">
        <thead>
          <tr><th>表示順</th><th>項目</th><th>予算額</th><th>操作</th></tr>
        </thead>
        <tbody id="budgetTableBody">
          <% budgetItems.sort((a, b) => (a.display_order || 0) - (b.display_order || 0)).forEach((item, index) => { %>
            <tr>
              <td>
                <input type="number" name="items[<%= index %>][display_order]" value="<%= item.display_order || index + 1 %>" class="form-control" required>
              </td>
              <td>
                <input type="text" name="items[<%= index %>][expense_item]" value="<%= item.expense_item %>" class="form-control" required>
              </td>
              <td>
                <input type="number" name="items[<%= index %>][budget]" value="<%= item.budget %>" class="form-control" required>
              </td>
              <td>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)"><i class="fas fa-trash-alt"></i></button>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
      <button type="button" class="btn btn-secondary btn-sm" onclick="addRowTo('items')">＋項目追加</button>
    </form>
    <hr>
    <div class="text-center mt-3">
      <button type="submit" form="budgetForm" class="btn btn-primary" style="width: 60%;">保存</button>
    </div>
  </div>

<script>
function addRowTo(sectionId) {
  const tbody = document.getElementById(sectionId + 'TableBody');
  const index = tbody.children.length;
  // 新しいdisplay_orderを決定
  let maxOrder = 0;
  for (let i = 0; i < tbody.children.length; i++) {
    const input = tbody.children[i].querySelector('input[name^="' + sectionId + '"][name$="[display_order]"]');
    if (input && !isNaN(input.value)) {
      const val = parseInt(input.value);
      if (val > maxOrder) maxOrder = val;
    }
  }
  const newOrder = maxOrder + 1;

  const newRow = document.createElement('tr');
  newRow.innerHTML = `
    <td>
      <input type="number" name="${sectionId}[${index}][display_order]" value="${newOrder}" class="form-control" required>
    </td>
    <td>
      <input type="text" name="${sectionId}[${index}][item]" class="form-control" required>
    </td>
    <td>
      <input type="number" name="${sectionId}[${index}][budget]" value="0" class="form-control" required>
    </td>
    <td>
      <button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">削除</button>
    </td>
  `;
  tbody.appendChild(newRow);
}

function addRowTo(sectionId) {
  // sectionIdに応じて、<tbody>のIDと項目名のキーを決定する
  const isExpense = sectionId === 'items';
  const tbodyId = isExpense ? 'budgetTableBody' : sectionId + 'TableBody';
  const itemNameKey = isExpense ? 'expense_item' : 'item';

  const tbody = document.getElementById(tbodyId);
  // tbodyが見つからない場合はエラーを出力して処理を中断
  if (!tbody) {
    console.error('Error: tbody element not found with id: ' + tbodyId);
    return;
  }

  const index = tbody.children.length;

  // 新しいdisplay_orderを決定
  let maxOrder = 0;
  // `[name^="${sectionId}"]` のようにテンプレートリテラルを使うと確実
  const selector = `input[name^="${sectionId}"][name$="[display_order]"]`;
  for (let i = 0; i < tbody.children.length; i++) {
    const input = tbody.children[i].querySelector(selector);
    if (input && input.value) { // input.valueが空でないこともチェック
      const val = parseInt(input.value, 10);
      if (!isNaN(val) && val > maxOrder) {
        maxOrder = val;
      }
    }
  }
  const newOrder = maxOrder + 1;

  const newRow = document.createElement('tr');
  // 項目名のキー（expense_item or item）を動的に設定する
  // 削除ボタンも他と合わせてアイコンにする
  newRow.innerHTML = `
    <td>
      <input type="number" name="${sectionId}[${index}][display_order]" value="${newOrder}" class="form-control" required>
    </td>
    <td>
      <input type="text" name="${sectionId}[${index}][${itemNameKey}]" class="form-control" required>
    </td>
    <td>
      <input type="number" name="${sectionId}[${index}][budget]" value="0" class="form-control" required>
    </td>
    <td>
      <button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)"><i class="fas fa-trash-alt"></i></button>
    </td>
  `;
  tbody.appendChild(newRow);
}

// addRow関数は不要になったので削除します。

function removeRow(button) {
  const row = button.closest('tr');
  row.remove();
}
</script>