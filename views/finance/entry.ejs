<% layout('layouts/boilerplate') %>
<% page = 'entry' %>

<div class="text-end mb-2">
  <a href="https://colts-wish-krs.craft.me/UJ4Y7muYdOwQlH/b/38F2763F-3027-4ECD-84A5-4AAC13520497/%E5%AE%B6%E8%A8%88%E7%B0%BF-%E6%96%B0%E8%A6%8F%E7%99%BB%E9%8C%B2"
     target="_blank" rel="noopener"
     class="badge bg-success text-white text-decoration-none p-2">
    ガイド
  </a>
</div>
  <div class="container">
    <div class="card shadow-sm">
      <div class="card-header text-white" style="background-color: #3a7ca5;">
        <h5 class="mb-0">収支の新規入力</h5>
      </div>
      <div class="card-body">
        <form action="/finance/entry" method="POST" enctype="multipart/form-data">
          <input type="hidden" name="finance[corrected_storeName]" id="corrected_storeName" value="<%= formData?.corrected_storeName || '' %>">
          <input type="hidden" name="finance[corrected_amount]" id="corrected_amount" value="<%= formData?.corrected_amount || '' %>">
          <input type="hidden" name="finance[corrected_date]" id="corrected_date" value="<%= formData?.corrected_date || '' %>">
            <!-- <div class="mb-3">
              <label for="receiptImage" class="form-label">レシート画像をアップロード（任意）</label>
              <input type="file" class="form-control" id="receiptImage" name="receiptImage" accept="image/*">
              <button type="button" class="btn btn-outline-primary mt-2" onclick="analyzeReceipt()">レシート画像から読み取る</button>
            </div> -->
              <!-- <hr> -->
                <div class="form-group">
                    <label for="date">年月日</label>
                    <!-- <input type="date" id="date" name="date"> -->
                    <input type="date" id="date" name="finance[date]" value="<%= formData?.corrected_date || formData?.date || '' %>" class="form-control <%= errors?.date ? 'error-field' : '' %>"><br>
                    <div class="error-message">
                        <%= errors?.date ? errors.date : '' %>
                    </div>
                </div>

                <div class="form-group">
                    <label for="large_cf">収支区分</label>
                    <select name="finance[cf]" id="cf" class="form-control <%= errors?.cf ? 'error-field' : '' %>">
                        <% for (let la_cf of la_cfs) { %>
                            <option value="<%= la_cf %>" <%= formData?.cf === la_cf ? 'selected' : '' %>><%= la_cf %></option>
                        <% } %>
                    </select>
                    <div class="error-message">
                        <%= errors?.cf ? errors.cf : '' %>
                    </div>
                </div>

                <!-- 支出区分 -->
                <div class="form-group category-group mb-2" id="expense_group" style="display: none;">
                  <div class="d-flex align-items-center">
                    <label for="expense_cf" class="me-2 mb-0" style="min-width: 90px;">支出区分</label>
                    <select name="finance[expense_item]" id="expense_cf" class="form-control">
                      <% for (let ex_cf of ex_cfs) {%>
                        <option value="<%= ex_cf %>"><%= ex_cf %></option>
                      <% } %>
                    </select>
                  </div>
                </div>

                <!-- 収入区分 -->
                <div class="form-group category-group mb-2" id="income_group" style="display: none;">
                  <div class="d-flex align-items-center">
                    <label for="income_cf" class="me-2 mb-0" style="min-width: 90px;">収入区分</label>
                    <select name="finance[income_item]" id="income_cf" class="form-control">
                      <% for (let in_item of in_items) {%>
                        <option value="<%= in_item %>"><%= in_item %></option>
                      <% } %>
                    </select>
                  </div>
                </div>

                <!-- 控除区分 -->
                <div class="form-group category-group mb-2" id="deduction_group" style="display: none;">
                  <div class="d-flex align-items-center">
                    <label for="dedu_cf" class="me-2 mb-0" style="min-width: 90px;">控除区分</label>
                    <select name="finance[dedu_item]" id="dedu_cf" class="form-control">
                      <% for (let dedu_cf of dedu_cfs) {%>
                        <option value="<%= dedu_cf %>"><%= dedu_cf %></option>
                      <% } %>
                    </select>
                  </div>
                </div>

                <!-- 貯蓄区分 -->
                <div class="form-group category-group mb-2" id="saving_group" style="display: none;">
                  <div class="d-flex align-items-center">
                    <label for="saving_cf" class="me-2 mb-0" style="min-width: 90px;">貯蓄区分</label>
                    <select name="finance[saving_item]" id="saving_cf" class="form-control">
                      <% for (let saving_cf of saving_cfs) {%>
                        <option value="<%= saving_cf %>"><%= saving_cf %></option>
                      <% } %>
                    </select>
                  </div>
                </div>
                
                <div class="form-group">
                  <% if (formData?.corrected_storeName) { %>
                    <div class="mb-1">
                      <span class="badge bg-info text-dark">店舗名: <%= formData.corrected_storeName %></span>
                    </div>
                  <% } %>
                    <label for="content">内容</label>
                    <textarea name="finance[content]" id="content"  inputmode="text" style="ime-mode: active;" class="form-control" rows="3" cols="40" placeholder="内容を入力してください"></textarea>
                </div>
                <div class="form-group">
                    <label for="amount">金額</label>
                    <input type="number" name="finance[amount]" inputmode="numeric" style="ime-mode: inactive;" class="form-control" id="amount" value="<%= formData?.corrected_amount || formData?.amount || '' %>" class="<%= errors?.amount ? 'error-field' : '' %>">
                    <div class="error-message">
                        <%= errors?.amount ? errors.amount : '' %>
                    </div>
                </div>
                <div class="form-group">
                    <label for="payment_cf">支払種別</label>
                      <select name="finance[payment_type]" id="payment_type" class="form-control <%= errors?.payment_type ? 'error-field' : '' %>">
                        <% pay_cfs.forEach(pay_cf => { %>
                          <option value="<%= pay_cf %>" <%= formData?.payment_type === pay_cf ? 'selected' : '' %>><%= pay_cf %></option>
                        <% }) %>
                      </select>
                    <div class="error-message">
                        <%= errors?.payment_type ? errors.payment_type : '' %>
                    </div>
                </div>
                <div class="form-group">
                    <label for="memo">メモ</label>
                    <textarea name="finance[memo]" id="memo" class="form-control" rows="2" placeholder="メモを入力してください"><%= formData?.memo || '' %></textarea>
                </div>
                <div class="form-group">
                    <label for="who">使用者</label>
                    <select name="finance[user]" id="who" class="form-control <%= errors.user ? 'error-field' : '' %>">
                      <% for (let u of allUsers || []) { 
                           const name = u.displayname || u.username;
                      %>
                        <option value="<%= name %>" <%= (formData?.user === name || currentUser.displayname === name) ? 'selected' : '' %>><%= name %></option>
                      <% } %>
                    </select>
                    <div class="error-message">
                        <%= errors?.user ? errors.user : '' %>
                    </div>
                </div>
                <hr>
                  <div class="mb-4">
                    <h5><strong>レシートの明細（任意）</strong></h5>
                    <div id="tagItemsArea">
                      <div class="tag-item d-flex align-items-end gap-2 mb-2">
                        <div class="flex-fill">
                          <input type="text" class="form-control" name="tagItems[0][name]" placeholder="品目名">
                        </div>
                        <div class="flex-fill">
                          <select class="form-select" name="tagItems[0][category]" onchange="recalculateSubtotal()">
                            <% ex_cfs.forEach(function(c) { %>
                              <option value="<%= c %>"><%= c %></option>
                            <% }); %>
                          </select>
                        </div>
                        <div class="flex-fill">
                          <input type="number" class="form-control" name="tagItems[0][price]" placeholder="金額" oninput="recalculateSubtotal()">
                        </div>
                      </div>
                    </div>
                    <div class="mb-3">
                      <button type="button" class="btn btn-outline-secondary" onclick="addTagItem()">＋項目を追加</button>
                    </div>
                    <div id="categorySubtotals" class="mt-4">
                      <h5><strong>支出区分別 小計</strong></h5>
                      <div id="categorySubtotalList" class="border-top pt-2"></div>
                    </div>
                  </div>
                <hr>
                <input type="hidden" name="nextAction" id="nextActionInput" value="list">
                <div class="form-group mb-0">
                    <button type="submit" class="c-button" onclick="document.getElementById('nextActionInput').value='list'">保存</button>
                    
                    <div class="spinner-border text-dark d-none ms-2" role="status" style="width: 1.5rem; height: 1.5rem;">
                        <span class="visually-hidden">送信中...</span>
                    </div>
                </div>
                <div class="text-center">
                    <small class="form-text text-muted">このデータを保存して、Topページに戻る</small>
                </div>
                <hr>
                <div class="form-group mb-0">
                        <input type="hidden" name="nextAction" value="duplicate">
                        <button type="submit" class="d-button" onclick="document.getElementById('nextActionInput').value='duplicate'">続けて入力</button>
                    <div class="spinner-border text-primary d-none ms-2" role="status" style="width: 1.5rem; height: 1.5rem;">
                        <span class="visually-hidden">送信中...</span>
                    </div>
                </div>
                <div class="text-center">
                    <small class="form-text text-muted">このデータを保存して、同じ内容を複製して変更点だけを編集する</small>
                </div>
        </form>

      </div>
    </div>
  </div>
<div id="customAlert" class="alert alert-warning alert-dismissible fade show d-none" role="alert" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; max-width: 400px; background-color: rgb(255, 0, 0); color: white;">  <span id="customAlertMessage">メッセージ</span>
  <button type="button" class="btn-close" aria-label="Close" onclick="hideCustomAlert()"></button>
</div>

<script>
  const categories = <%- JSON.stringify(ex_cfs) %>;
  let tagItemCount = 1;

  function addTagItem() {
    const area = document.getElementById('tagItemsArea');
    const itemDiv = document.createElement('div');
    itemDiv.className = 'tag-item d-flex align-items-end gap-2 mb-2';
    itemDiv.innerHTML = `
      <div class="flex-fill">
        <input type="text" class="form-control" name="tagItems[${tagItemCount}][name]" placeholder="品目名">
      </div>
      <div class="flex-fill">
        <select class="form-select" name="tagItems[${tagItemCount}][category]" onchange="recalculateSubtotal()">
          ${categories.map(c => `<option value="${c}">${c}</option>`).join('')}
        </select>
      </div>
      <div class="flex-fill">
        <input type="number" class="form-control" name="tagItems[${tagItemCount}][price]" placeholder="金額" oninput="recalculateSubtotal()">
      </div>
    `;
    area.appendChild(itemDiv);
    tagItemCount++;
  }

  function recalculateSubtotal() {
    const items = document.querySelectorAll('.tag-item');
    const categoryTotals = {};

    items.forEach(item => {
      const category = item.querySelector('select').value;
      const priceInput = item.querySelector('input[name$="[price]"]');
      const val = parseFloat(priceInput.value);
      if (!isNaN(val)) {
        categoryTotals[category] = (categoryTotals[category] || 0) + val;
      }
    });

    const subtotalList = document.getElementById('categorySubtotalList');
    subtotalList.innerHTML = '';
    for (const [category, total] of Object.entries(categoryTotals)) {
      subtotalList.innerHTML += `<div>・${category}: ¥${total.toLocaleString()}</div>`;
    }
  }
</script>