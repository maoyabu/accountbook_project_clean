<% layout('layouts/boilerplate') %>
<% page = 'entry' %>

<div class="text-end mb-2">
  <a href="https://colts-wish-krs.craft.me/UJ4Y7muYdOwQlH/b/38F2763F-3027-4ECD-84A5-4AAC13520497/%E5%AE%B6%E8%A8%88%E7%B0%BF-%E6%96%B0%E8%A6%8F%E7%99%BB%E9%8C%B2"
     target="_blank" rel="noopener"
     class="badge bg-success text-white text-decoration-none p-2">
    ガイド
  </a>
</div>
  <div class="container finance-form-container">
    <div class="card shadow-sm">
      <div class="card-header text-white" style="background-color: #3a7ca5;">
        <h5 class="mb-0">収支の新規入力</h5>
      </div>
      <div class="card-body">
        <% if (typeof duplicateMessage !== 'undefined' && duplicateMessage) { %>
          <div class="alert alert-success text-center" role="alert"><%= duplicateMessage %></div>
        <% } %>
        <form action="/finance/entry" method="POST" enctype="multipart/form-data">
          <input type="hidden" name="finance[corrected_storeName]" id="corrected_storeName" value="<%= formData?.corrected_storeName || '' %>">
          <input type="hidden" name="finance[corrected_amount]" id="corrected_amount" value="<%= formData?.corrected_amount || '' %>">
          <input type="hidden" name="finance[corrected_date]" id="corrected_date" value="<%= formData?.corrected_date || '' %>">
            <!-- <div class="mb-3">
              <label for="receiptImage" class="form-label">レシート画像をアップロード（任意）</label>
              <input type="file" class="form-control" id="receiptImage" name="receiptImage" accept="image/*">
              <button type="button" class="btn btn-outline-primary mt-2" onclick="analyzeReceipt()">レシート画像から読み取る</button>
            </div> -->
              <!-- <hr> -->
                <div class="form-group">
                    <label for="date">年月日</label>
                    <!-- <input type="date" id="date" name="date"> -->
                    <input type="date" id="date" name="finance[date]" value="<%= formData?.corrected_date || formData?.date || '' %>" class="form-control date-input <%= errors?.date ? 'error-field' : '' %>"><br>
                    <div class="error-message">
                        <%= errors?.date ? errors.date : '' %>
                    </div>
                </div>

                <div class="form-group">
                    <label for="large_cf">収支区分</label>
                    <select name="finance[cf]" id="cf" class="form-control short-input <%= errors?.cf ? 'error-field' : '' %>">
                        <% for (let la_cf of la_cfs) { %>
                            <option value="<%= la_cf %>" <%= formData?.cf === la_cf ? 'selected' : '' %>><%= la_cf %></option>
                        <% } %>
                    </select>
                    <div class="error-message">
                        <%= errors?.cf ? errors.cf : '' %>
                    </div>
                </div>

                <!-- 支出区分 -->
                <div class="form-group category-group mb-2" id="expense_group" style="display: none;">
                  <div class="d-flex align-items-center">
                    <label for="expense_cf" class="me-2 mb-0" style="min-width: 90px;">支出区分</label>
                    <select name="finance[expense_item]" id="expense_cf" class="form-control short-input <%= errors?.expense_item ? 'error-field' : '' %>">
                      <% for (let ex_cf of ex_cfs) {%>
                        <option value="<%= ex_cf %>" <%= formData?.expense_item === ex_cf ? 'selected' : '' %>><%= ex_cf %></option>
                      <% } %>
                    </select>
                    <div class="error-message">
                      <%= errors?.expense_item ? errors.expense_item : '' %>
                    </div>
                  </div>
                </div>

                <!-- 収入区分 -->
                <div class="form-group category-group mb-2" id="income_group" style="display: none;">
                  <div class="d-flex align-items-center">
                    <label for="income_cf" class="me-2 mb-0" style="min-width: 90px;">収入区分</label>
                    <select name="finance[income_item]" id="income_cf" class="form-control short-input <%= errors?.income_item ? 'error-field' : '' %>">
                      <% for (let in_item of in_items) {%>
                        <option value="<%= in_item %>" <%= formData?.income_item === in_item ? 'selected' : '' %>><%= in_item %></option>
                      <% } %>
                    </select>
                    <div class="error-message">
                      <%= errors?.income_item ? errors.income_item : '' %>
                    </div>
                  </div>
                </div>

                <!-- 控除区分 -->
                <div class="form-group category-group mb-2" id="deduction_group" style="display: none;">
                  <div class="d-flex align-items-center">
                    <label for="dedu_cf" class="me-2 mb-0" style="min-width: 90px;">控除区分</label>
                    <select name="finance[dedu_item]" id="dedu_cf" class="form-control short-input <%= errors?.dedu_item ? 'error-field' : '' %>">
                      <% for (let dedu_cf of dedu_cfs) {%>
                        <option value="<%= dedu_cf %>" <%= formData?.dedu_item === dedu_cf ? 'selected' : '' %>><%= dedu_cf %></option>
                      <% } %>
                    </select>
                    <div class="error-message">
                      <%= errors?.dedu_item ? errors.dedu_item : '' %>
                    </div>
                  </div>
                </div>

                <!-- 貯蓄区分 -->
                <div class="form-group category-group mb-2" id="saving_group" style="display: none;">
                  <div class="d-flex align-items-center">
                    <label for="saving_cf" class="me-2 mb-0" style="min-width: 90px;">貯蓄区分</label>
                    <select name="finance[saving_item]" id="saving_cf" class="form-control short-input <%= errors?.saving_item ? 'error-field' : '' %>">
                      <% for (let saving_cf of saving_cfs) {%>
                        <option value="<%= saving_cf %>" <%= formData?.saving_item === saving_cf ? 'selected' : '' %>><%= saving_cf %></option>
                      <% } %>
                    </select>
                    <div class="error-message">
                      <%= errors?.saving_item ? errors.saving_item : '' %>
                    </div>
                  </div>
                </div>
                
                <div class="form-group">
                  <% if (formData?.corrected_storeName) { %>
                    <div class="mb-1">
                      <span class="badge bg-info text-dark">店舗名: <%= formData.corrected_storeName %></span>
                    </div>
                  <% } %>
                    <label for="content">内容</label>
                    <textarea name="finance[content]" id="content"  inputmode="text" style="ime-mode: active;" class="form-control" rows="3" cols="40" placeholder="内容を入力してください"></textarea>
                </div>
                <div class="form-group">
                    <label for="amount">金額</label>
                    <input type="number" name="finance[amount]" inputmode="numeric" style="ime-mode: inactive;" class="form-control short-input" id="amount" value="<%= formData?.corrected_amount || formData?.amount || '' %>" class="<%= errors?.amount ? 'error-field' : '' %>">
                    <div class="error-message">
                        <%= errors?.amount ? errors.amount : '' %>
                    </div>
                </div>
                <div class="form-group">
                    <label for="payment_cf">支払種別</label>
                      <select name="finance[payment_type]" id="payment_type" class="form-control short-input <%= errors?.payment_type ? 'error-field' : '' %>">
                        <% pay_cfs.forEach(pay_cf => { %>
                          <option value="<%= pay_cf %>" <%= formData?.payment_type === pay_cf ? 'selected' : '' %>><%= pay_cf %></option>
                        <% }) %>
                      </select>
                    <div class="error-message">
                        <%= errors?.payment_type ? errors.payment_type : '' %>
                    </div>
                </div>
                <div class="form-group">
                    <label for="memo">メモ</label>
                    <textarea name="finance[memo]" id="memo" class="form-control" rows="2" placeholder="メモを入力してください"><%= formData?.memo || '' %></textarea>
                </div>
                <div class="form-group">
                    <label for="who">使用者</label>
                    <select name="finance[user]" id="who" class="form-control short-input <%= errors.user ? 'error-field' : '' %>">
                      <% for (let u of allUsers || []) { 
                           const name = u.displayname || u.username;
                      %>
                        <option value="<%= name %>" <%= (formData?.user === name || currentUser.displayname === name) ? 'selected' : '' %>><%= name %></option>
                      <% } %>
                    </select>
                    <div class="error-message">
                        <%= errors?.user ? errors.user : '' %>
                    </div>
                </div>
                <hr>
                  <div class="mb-4">
                    <h5><strong>レシートの明細（任意）</strong></h5>
                    <div id="tagItemsArea">
                      <div class="tag-item d-flex align-items-end gap-2 mb-2">
                        <div class="flex-fill">
                          <input type="text" class="form-control" name="tagItems[0][name]" placeholder="品目名">
                        </div>
                        <div class="flex-fill">
                          <select class="form-select" name="tagItems[0][category]" onchange="recalculateSubtotal()">
                            <% ex_cfs.forEach(function(c) { %>
                              <option value="<%= c %>"><%= c %></option>
                            <% }); %>
                          </select>
                        </div>
                        <div class="flex-fill">
                          <input type="number" class="form-control" name="tagItems[0][price]" placeholder="金額" oninput="recalculateSubtotal()">
                        </div>
                      </div>
                    </div>
                    <div class="mb-3">
                      <button type="button" class="btn btn-outline-secondary" onclick="addTagItem()">＋項目を追加</button>
                    </div>
                    <div id="categorySubtotals" class="mt-4">
                      <h5><strong>支出区分別 小計</strong></h5>
                      <div id="categorySubtotalList" class="border-top pt-2"></div>
                    </div>
                  </div>
                <hr>
                <input type="hidden" name="nextAction" id="nextActionInput" value="list">
                <div class="form-group mb-0">
                    <button type="submit" class="c-button" onclick="document.getElementById('nextActionInput').value='list'">保存</button>
                    
                    <div class="spinner-border text-dark d-none ms-2" role="status" style="width: 1.5rem; height: 1.5rem;">
                        <span class="visually-hidden">送信中...</span>
                    </div>
                </div>
                <div class="text-center">
                    <small class="form-text text-muted">このデータを保存して、Topページに戻る</small>
                </div>
                <hr>
                <div class="form-group mb-0">
                        <input type="hidden" name="nextAction" value="duplicate">
                        <button type="submit" class="d-button" onclick="document.getElementById('nextActionInput').value='duplicate'">続けて入力</button>
                    <div class="spinner-border text-primary d-none ms-2" role="status" style="width: 1.5rem; height: 1.5rem;">
                        <span class="visually-hidden">送信中...</span>
                    </div>
                </div>
                <div class="text-center">
                    <small class="form-text text-muted">このデータを保存して、同じ内容を複製して変更点だけを編集する</small>
                </div>
        </form>

      </div>
    </div>
  </div>
<div id="customAlert" class="alert alert-warning alert-dismissible fade show d-none" role="alert" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; max-width: 400px; background-color: rgb(255, 0, 0); color: white;">  <span id="customAlertMessage">メッセージ</span>
  <button type="button" class="btn-close" aria-label="Close" onclick="hideCustomAlert()"></button>
</div>

<script>
  const categories = <%- JSON.stringify(ex_cfs) %>;
  let tagItemCount = 1;
  const cfSelect = document.getElementById('cf');
  const expenseGroup = document.getElementById('expense_group');
  const incomeGroup = document.getElementById('income_group');
  const deductionGroup = document.getElementById('deduction_group');
  const savingGroup = document.getElementById('saving_group');
  const expenseSelect = document.getElementById('expense_cf');
  const incomeSelect = document.getElementById('income_cf');
  const deductionSelect = document.getElementById('dedu_cf');
  const savingSelect = document.getElementById('saving_cf');
  const paymentSelect = document.getElementById('payment_type');
  const dateInput = document.getElementById('date');
  const amountInput = document.getElementById('amount');

  function updateCategoryVisibility() {
    expenseGroup.style.display = 'none';
    incomeGroup.style.display = 'none';
    deductionGroup.style.display = 'none';
    savingGroup.style.display = 'none';

    switch (cfSelect.value) {
      case '支出':
        expenseGroup.style.display = 'block';
        break;
      case '収入':
        incomeGroup.style.display = 'block';
        break;
      case '控除':
        deductionGroup.style.display = 'block';
        break;
      case '貯蓄':
        savingGroup.style.display = 'block';
        break;
      default:
        break;
    }
  }

  function showCustomAlert(message) {
    const alertBox = document.getElementById('customAlert');
    document.getElementById('customAlertMessage').textContent = message;
    alertBox.classList.remove('d-none');
  }

  function hideCustomAlert() {
    document.getElementById('customAlert').classList.add('d-none');
    resetSpinners();
  }

  function getErrorBox(el) {
    return el?.closest('.form-group')?.querySelector('.error-message');
  }

  function setFieldError(el, message) {
    if (!el) return;
    el.classList.add('error-field');
    const box = getErrorBox(el);
    if (box) box.textContent = message;
  }

  function clearFieldErrors() {
    document.querySelectorAll('.error-field').forEach(el => el.classList.remove('error-field'));
    document.querySelectorAll('.error-message').forEach(box => { box.textContent = ''; });
  }

  function resetSpinners() {
    document.querySelectorAll('.spinner-border').forEach(s => s.classList.add('d-none'));
    document.querySelectorAll('button[type="submit"]').forEach(b => {
      b.disabled = false;
      if (b.dataset.originalLabel) b.textContent = b.dataset.originalLabel;
    });
  }

  function validateRequiredFields(event) {
    const cfValue = cfSelect.value;
    clearFieldErrors();
    const missing = [];
    if (!dateInput.value) missing.push('date');
    if (!cfValue || cfValue === 'Please Choice') missing.push('cf');
    if (cfValue === '支出' && (!expenseSelect.value || expenseSelect.value === 'Please Choice')) missing.push('expense');
    if (cfValue === '収入' && (!incomeSelect.value || incomeSelect.value === 'Please Choice')) missing.push('income');
    if (cfValue === '控除' && (!deductionSelect.value || deductionSelect.value === 'Please Choice')) missing.push('deduction');
    if (cfValue === '貯蓄' && (!savingSelect.value || savingSelect.value === 'Please Choice')) missing.push('saving');
    if (!amountInput.value) missing.push('amount');
    if (!paymentSelect.value || paymentSelect.value === 'Please Choice') missing.push('payment');

    if (missing.length > 0) {
      event.preventDefault();
      event.stopImmediatePropagation();
      showCustomAlert('未入力項目があります、必須項目を入力してから更新か続けて入力してください');
      // set field-specific messages and red borders
      if (missing.includes('date')) setFieldError(dateInput, '日付は必須です');
      if (missing.includes('cf')) setFieldError(cfSelect, '収支区分は必須です。まだ登録は完了していません。');
      if (missing.includes('expense')) setFieldError(expenseSelect, '支出区分は必須です。まだ登録は完了していません。');
      if (missing.includes('income')) setFieldError(incomeSelect, '収入区分は必須です。まだ登録は完了していません。');
      if (missing.includes('deduction')) setFieldError(deductionSelect, '控除区分は必須です。まだ登録は完了していません。');
      if (missing.includes('saving')) setFieldError(savingSelect, '貯蓄区分は必須です。まだ登録は完了していません。');
      if (missing.includes('amount')) setFieldError(amountInput, '金額は必須です');
      if (missing.includes('payment')) setFieldError(paymentSelect, '支払種別は必須です、まだ登録は完了してません。');
      resetSpinners();
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    updateCategoryVisibility();
    cfSelect.addEventListener('change', updateCategoryVisibility);
    // store original button labels for reset
    document.querySelectorAll('button[type=\"submit\"]').forEach(b => {
      if (!b.dataset.originalLabel) b.dataset.originalLabel = b.textContent;
    });
    const entryForm = document.querySelector('form[action=\"/finance/entry\"]');
    if (entryForm) {
      entryForm.addEventListener('submit', validateRequiredFields, true);
    }
  });

  function addTagItem() {
    const area = document.getElementById('tagItemsArea');
    const itemDiv = document.createElement('div');
    itemDiv.className = 'tag-item d-flex align-items-end gap-2 mb-2';
    itemDiv.innerHTML = `
      <div class="flex-fill">
        <input type="text" class="form-control" name="tagItems[${tagItemCount}][name]" placeholder="品目名">
      </div>
      <div class="flex-fill">
        <select class="form-select" name="tagItems[${tagItemCount}][category]" onchange="recalculateSubtotal()">
          ${categories.map(c => `<option value="${c}">${c}</option>`).join('')}
        </select>
      </div>
      <div class="flex-fill">
        <input type="number" class="form-control" name="tagItems[${tagItemCount}][price]" placeholder="金額" oninput="recalculateSubtotal()">
      </div>
    `;
    area.appendChild(itemDiv);
    tagItemCount++;
  }

  function recalculateSubtotal() {
    const items = document.querySelectorAll('.tag-item');
    const categoryTotals = {};

    items.forEach(item => {
      const category = item.querySelector('select').value;
      const priceInput = item.querySelector('input[name$="[price]"]');
      const val = parseFloat(priceInput.value);
      if (!isNaN(val)) {
        categoryTotals[category] = (categoryTotals[category] || 0) + val;
      }
    });

    const subtotalList = document.getElementById('categorySubtotalList');
    subtotalList.innerHTML = '';
    for (const [category, total] of Object.entries(categoryTotals)) {
      subtotalList.innerHTML += `<div>・${category}: ¥${total.toLocaleString()}</div>`;
    }
  }
</script>
