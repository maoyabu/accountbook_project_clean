<% layout('layouts/boilerplate') %>

<div class="text-end mb-2">
  <a href="https://colts-wish-krs.craft.me/UJ4Y7muYdOwQlH/b/1CF1BF91-DFE4-4740-A3DE-0B47D1111C50/%E5%AE%B6%E8%A8%88%E7%B0%BF-%E3%83%AC%E3%82%B7%E3%83%BC%E3%83%88%E3%81%8B%E3%82%89%E8%AA%AD%E5%8F%96%E3%82%8B%EF%BC%88%E6%9C%89%E6%96%99%EF%BC%89"
    target="_blank" rel="noopener"
    class="badge bg-success text-white text-decoration-none p-2">
    ガイド
  </a>
</div>
<div class="container">
  <div id="customAlert" class="alert alert-primary alert-dismissible fade show d-none position-fixed top-50 start-50 translate-middle shadow" role="alert" style="z-index: 1050; min-width: 300px;">
    <span id="customAlertMessage"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  <div class="card shadow-sm">
    <div class="card-header text-white" style="background-color: #3a7ca5;">
      <h5 class="mb-0">レシートからの新規支出登録</h5>
    </div>
    <div class="card-body">

  <form action="/finance/receipt/create" method="POST">
    <div class="mb-3">
      <label for="receiptImage" class="form-label">レシート画像を指定して抽出する</label>
      <input type="file" class="form-control" id="receiptImage" name="receiptImage" accept="image/*">
      <button type="button" class="btn btn-outline-primary mt-2" onclick="analyzeReceiptNew()">レシート画像から読み取る</button>
      <div id="loadingSpinner" class="spinner-border text-primary mt-2 d-none" role="status">
        <span class="visually-hidden">読み取り中...</span>
      </div>
      <div id="ocrResult" class="mt-3"></div>
    </div>
    <div class="mb-3">
    <hr>
      <label for="date" class="form-label">支払日</label>
      <input type="date" class="form-control" id="date" name="date" value="<%= ocrData.date || '' %>" required>
    </div>

    <div class="mb-3">
      <label for="cf" class="form-label">収支区分</label>
      <input type="text" class="form-control" id="cf" name="cf" value="支出" readonly>
    </div>

    <div class="mb-3">
      <label for="content" class="form-label">店舗名（内容）</label>
      <input type="text" class="form-control" id="content" name="storeName" value="<%= ocrData.storeName || '' %>" required>
    </div>

    <div class="mb-3">
      <label for="payment_type" class="form-label">支払種別<strong style="color: red;">（必須）</strong></label>
      <select class="form-select" id="payment_type" name="payment_type" required>
        <% pay_cfs.forEach(type => { %>
          <option value="<%= type %>"><%= type %></option>
        <% }) %>
      </select>
    </div>

    <div class="mb-3">
      <label for="memo" class="form-label">メモ（任意）</label>
      <textarea class="form-control" id="memo" name="memo" rows="2" placeholder="メモを入力してください"><%= memo || '' %></textarea>
    </div>

    <div class="mb-3">
      <label for="user" class="form-label">使用者</label>
      <input type="text" class="form-control" value="<%= currentUser.displayname %>" disabled>
    </div>
    <div class="mb-3">
        <label for="amount" class="form-label">合計金額</label>
        <input type="number" class="form-control" id="amount" readonly>
    </div>
    <hr>
    <div class="mb-4">
      <h5><strong>支出内容</strong></h5>
      <% if (ocrData.tagGroups && ocrData.tagGroups.length > 0) { %>
        <% ocrData.tagGroups.forEach((group, gIdx) => { %>
          <div class="border rounded p-3 mb-3">
            <div class="mb-2">
              <label class="form-label">支出区分</label>
              <input type="text" class="form-control" name="tagGroups[<%= gIdx %>][category]" value="<%= group.category %>" required>
            </div>
            <% group.tags.forEach((tag, tIdx) => { %>
              <div class="mb-2">
                <label class="form-label">タグ（購入明細）</label>
                <input type="text" class="form-control" name="tagGroups[<%= gIdx %>][tags][<%= tIdx %>][name]" value="<%= tag.name %>">
                <input type="hidden" name="tagGroups[<%= gIdx %>][tags][<%= tIdx %>][category]" value="<%= tag.category %>">
                <input type="number" class="form-control mt-1" name="tagGroups[<%= gIdx %>][tags][<%= tIdx %>][price]" value="<%= tag.price %>">
              </div>
            <% }) %>
            <div class="mb-2">
              <label class="form-label">支出区分合計金額</label>
              <input type="number" class="form-control" name="tagGroups[<%= gIdx %>][amount]" value="<%= group.amount %>" required>
            </div>
          </div>
        <% }) %>
      <% } %>
      <div id="tagPreviewArea" class="mt-3"></div>
      <div id="categorySubtotals" class="mt-4">
        <h5><strong>支出区分別 小計</strong></h5>
        <div id="categorySubtotalList" class="border-top pt-2"></div>
      </div>
    </div>
    <hr>
    <div class="text-center mt-4">
      <button type="submit" class="btn btn-primary w-60" style="width: 60%;">保存</button>
    </div>
  <script>
    document.querySelector('form').addEventListener('submit', function(e) {
      const paymentSelect = document.getElementById('payment_type');
      if (!paymentSelect.value || paymentSelect.value.trim() === '') {
        e.preventDefault();
        alert('支払種別を選択してください。');
        paymentSelect.focus();
      }
    });
  </script>
  </form>
<script>
function renderTagsNew(tags) {
  const container = document.getElementById('tagPreviewArea');
  if (!container) return;
  container.innerHTML = '';

  const grouped = {};
  tags.forEach(tag => {
    const key = tag.category || '未分類';
    if (!grouped[key]) {
      grouped[key] = [];
    }
    grouped[key].push(tag);
  });

  const allTags = Object.values(grouped).flat();
  allTags.forEach((tag, idx) => {
    const rowDiv = document.createElement('div');
    rowDiv.className = 'd-flex align-items-center mb-2 gap-2';

    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.className = 'form-control';
    nameInput.name = `tags[${idx}][name]`;
    nameInput.value = tag.name;

    const categorySelect = document.createElement('select');
    categorySelect.className = 'form-select';
    categorySelect.name = `tags[${idx}][category]`;
    const ex_cfs = ['副食物費','主食費1','主食費2','調味料','光熱費','住宅・家具費','衣服費','教育費','交際費','教養費','娯楽費','保険・衛生費','職業費','特別費','公共費','車関連費','通信費','外税'];
    ex_cfs.forEach(option => {
      const opt = document.createElement('option');
      opt.value = option;
      opt.textContent = option;
      if (option === tag.category) opt.selected = true;
      categorySelect.appendChild(opt);
    });

    const priceInput = document.createElement('input');
    priceInput.type = 'number';
    priceInput.className = 'form-control text-end';
    priceInput.name = `tags[${idx}][price]`;
    priceInput.value = tag.price;

    // Add event listeners for real-time subtotal updates
    categorySelect.onchange = priceInput.oninput = () => {
      allTags[idx].category = categorySelect.value;
      allTags[idx].price = priceInput.value;
      updateCategorySubtotals(allTags);
    };

    rowDiv.appendChild(nameInput);
    rowDiv.appendChild(categorySelect);
    rowDiv.appendChild(priceInput);

    container.appendChild(rowDiv);
  });

  function updateCategorySubtotals(tags) {
    const subtotalContainer = document.getElementById('categorySubtotalList');
    if (!subtotalContainer) return;
    subtotalContainer.innerHTML = '';

    const subtotals = {};
    tags.forEach(tag => {
      const cat = tag.category || '未分類';
      subtotals[cat] = (subtotals[cat] || 0) + (Number(tag.price) || 0);
    });

    Object.entries(subtotals).forEach(([cat, total]) => {
      const div = document.createElement('div');
      div.className = 'd-flex justify-content-between border-bottom py-1';
      div.innerHTML = `<strong>${cat}</strong><span>¥${total.toLocaleString()}</span>`;
      subtotalContainer.appendChild(div);
    });
  }

  // 既存 renderTagsNew の末尾に以下を追加
  updateCategorySubtotals(tags);
}
</script>

</div></div></div>
