<% layout('layouts/boilerplate') %>
<div class="d-flex flex-column align-items-end mb-2">
  <div class="mb-2">
    <a href="https://colts-wish-krs.craft.me/UJ4Y7muYdOwQlH/b/92E67D67-06CA-419D-9624-FF744630C126/%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3%E5%BE%8C%E3%80%81%E6%9C%80%E5%88%9D%E3%81%AE%E8%A8%AD%E5%AE%9A"
      target="_blank" rel="noopener"
      class="badge bg-warning text-white text-decoration-none p-2">
      ガイド
    </a>
  </div>
  <div style="width: 30%;">
    <% if (resume) { %>
      <a href="/resume/edit/<%= resume._id %>" class="btn btn-success w-100">My履歴書の更新</a>
    <% } else { %>
      <a href="/resume" class="btn btn-primary w-100">My履歴書の作成</a>
    <% } %>
  </div>
</div>

<div class="card shadow-sm">
    <div class="card-header text-white" style="background-color: #3a7ca5;">
      <h5 class="mb-0">プロフィール編集</h5>
    </div>
    <div class="card-body">
    <form action="/profile/<%= user._id %>?_method=PUT" method="POST" enctype="multipart/form-data">
        <div class="d-flex align-items-center mb-3">
            <% if (user.avatar) { %>
                <label for="avatar" class="me-3" style="cursor: pointer;">
                    <img src="<%= user.avatar %>" alt="プロフィール画像" class="navbar-avatar1">
                </label>
            <% } else { %>
                <button type="button" class="btn btn-outline-secondary me-3" onclick="document.getElementById('avatar').click()">アバターを追加</button>
            <% } %>
            <div>
                <% if (currentUser.isAdmin) { %>
                  <div><span class="badge" style="background-color: goldenrod; color: white; margin-left: 0.5rem;"><a href="/admin" style="color: white; text-decoration: none; ">暮らしのサポーター管理者</a></span></div>
                <% } %>
                
                
                <div>
                    <label for="username" class="form-label mb-0">【ログインユーザー名】 <%= user.username %></label>
                </div>
                <% if (user.groups && user.groups.length > 0) { %>
                    <div class="mb-3 d-flex align-items-center">
                        <!-- ラベル部分 -->
                        <label class="form-label fw-bold mb-0" style="min-width: 100px;">【参加グループ】</label>
                        <!-- グループリスト -->
                        <ul class="list-group flex-grow-1">
                          <% user.groups.forEach(group => { %>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                              <!-- グループ名にリンクをつける -->
                              <a href="/group/show/<%= group._id %>" class="text-decoration-none">
                                <%= group.group_name %>　
                              </a>
                              <!-- 管理者かユーザーかの表示 -->
                              <% if (group.createdBy && group.createdBy._id.toString() === user._id.toString()) { %>
                                <span class="badge bg-primary rounded-pill">管理者</span>
                              <% } else { %>
                                <span class="badge bg-secondary rounded-pill">ユーザー</span>
                              <% } %>
                            </li>
                          <% }) %>
                        </ul>
                      </div>
                <% } else { %>
                    <div class="d-flex align-items-center mb-2">
                        <label class="form-label mb-0 me-2">【参加グループ】</label>
                        <span>なし</span>
                    </div>
                <% } %>
                <div class="flex-grow-1">
                    <!-- プロフィール画像 -->
                    <label for="avatar" class="form-label visually-hidden">画像変更</label>
                    <input class="form-control visually-hidden" type="file" id="avatar" name="avatar">
                </div>
            </div>
        </div>
        
        <hr>
        <!-- ユーザー名 -->
        <div class="mb-3">
            <label for="displayname" class="form-label">【表示名】</label>
            <input type="text" class="form-control" id="displayname" name="displayname" value="<%= user.displayname %>" required>
        </div>
        <!-- メールアドレス -->
        <div class="mb-3">
            <label for="email" class="form-label">【メールアドレス】</label>
            <input type="email" class="form-control" id="email" name="email" value="<%= user.email %>" required>
        </div>
        <!-- 誕生日 -->
        <div class="mb-3">
            <label for="birth_date" class="form-label">【誕生日】</label>
            <input type="date" class="form-control" id="birth_date" name="birth_date"
                value="<%= user.birth_date ? user.birth_date.toISOString().substring(0, 10) : '' %>">
        </div>
        <!-- 性別 -->
        <div class="mb-3">
            <label for="sex" class="form-label">【性別】</label>
            <select class="form-select" id="sex" name="sex">
                <option value="">選択してください</option>
                <option value="男性" <%= user.sex === '男性' ? 'selected' : '' %>>男性</option>
                <option value="女性" <%= user.sex === '女性' ? 'selected' : '' %>>女性</option>
                <option value="その他" <%= user.sex === 'その他' ? 'selected' : '' %>>その他</option>
            </select>
        </div>
        <!-- 血液型・RH型 -->
        <div class="mb-3">
          <label for="blood" class="form-label">【血液型】</label>
          <div class="d-flex align-items-center">
            <select class="form-select me-2" id="blood" name="blood" style="max-width: 120px;">
              <option value="">選択</option>
              <option value="A" <%= user.blood === 'A' ? 'selected' : '' %>>A型</option>
              <option value="B" <%= user.blood === 'B' ? 'selected' : '' %>>B型</option>
              <option value="O" <%= user.blood === 'O' ? 'selected' : '' %>>O型</option>
              <option value="AB" <%= user.blood === 'AB' ? 'selected' : '' %>>AB型</option>
            </select>
            <select class="form-select" id="rh" name="rh" style="max-width: 80px;">
              <option value="">RH</option>
              <option value="+" <%= user.rh === '+' ? 'selected' : '' %>>＋</option>
              <option value="-" <%= user.rh === '-' ? 'selected' : '' %>>－</option>
            </select>
          </div>
        </div>
        <hr>
        <!-- メール通知の設定 -->
        <div class="mb-3 mt-3 form-check">
          <input type="checkbox" class="form-check-input" id="isMail" name="isMail" value="true" <%= user.isMail ? 'checked' : '' %>>
          <label class="form-check-label" for="isMail">メールでのお知らせを受け取る</label>
        </div>
        <hr>
        <div class="mb-3">
          <label class="form-label">【利用するサービス】</label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="service_allaboutme" name="services_allaboutme" value="true" <%= user.services?.allaboutme ? 'checked' : '' %>>            <label class="form-check-label" for="service_allaboutme">All About me</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="service_finance" name="services_finance" value="true" <%= user.services?.finance ? 'checked' : '' %>>            <label class="form-check-label" for="service_finance">家計簿 / Dashboard</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="service_assets" name="services_assets" value="true" <%= user.services?.assets ? 'checked' : '' %>>            <label class="form-check-label" for="service_assets">資産管理</label>
          </div>
        </div>
        <hr>
        <button type="submit" class="c-button">ユーザー情報を更新する</button>
        <div class="spinner-border text-primary d-none ms-2" role="status" style="width: 1.5rem; height: 1.5rem;">
          <span class="visually-hidden">送信中...</span>
        </div>
    </form>
    <hr>
    <h2 class="text-center"><a href="/reset-password">パスワードの変更はこちらから</a></h2>
    <hr>
    <div class="d-flex justify-content-between">
        <p>登録日：<%= user.entry_date ? user.entry_date.toLocaleString() : '未更新' %></p>
        <p>更新日：<%= user.update_date ? user.update_date.toLocaleString() : '未更新' %></p>
    </div>
    </div>
    <hr>
    <div class="d-flex justify-content-center mb-2">
      <form action="/unsubscribe" method="POST" onsubmit="return confirm('本当に退会しますか？一度退会すると今まで登録したデータは全て削除されてしまいます。またログインも出来なくなります')">
        <button class="btn btn-danger">退会する</button>
      </form>
    </div>
</div>