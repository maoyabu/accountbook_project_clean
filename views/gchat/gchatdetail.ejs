<% layout('layouts/boilerplate') %>
<div class="text-end">
  <a href="https://colts-wish-krs.craft.me/UJ4Y7muYdOwQlH/b/DF9C355B-DF21-4DD0-80E2-CC3A5A2CE876/gChat"
     target="_blank" rel="noopener"
     class="badge bg-warning text-white text-decoration-none p-2">
    ガイド
  </a>
</div>
<div class="container mt-3">
  <a href="/gchat" class="btn btn-outline-secondary mb-3">
    <i class="fas fa-arrow-left"></i> チャット一覧に戻る
  </a>
</div>
<div class="container">
  <!-- existing content of gchatDetail.ejs continues here -->
<div class="container mt-2">
  <div class="card shadow-sm mb-3">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        <i class="fas fa-comments me-2"></i><%= chat.title %>
        <% if (chat.members && chat.members.length > 0) { %>
          <small class="text-white ms-2 d-flex flex-wrap align-items-center gap-2">
            （
            <% chat.members.forEach(m => { %>
              <span class="d-flex align-items-center gap-1">
                <img src="<%= m.avatar && (m.avatar.startsWith('http') || m.avatar.startsWith('/images/')) ? m.avatar : '/images/def_user_icon.png' %>" alt="avatar" class="rounded-circle" style="width: 20px; height: 20px;">
                <%= m.displayname || m.username %>
              </span>
            <% }) %>
            ）
          </small>
        <% } %>
      </h5>
    </div>
    <div class="card-body p-3" style="background-color: #f8f9fa;">
      <div id="chat-box" class="mb-3" style="height: 400px; overflow-y: auto;">
        <% messages.forEach(msg => { %>
          <% if (msg.sender._id.toString() === currentUser._id.toString()) { %>
            <!-- 自分のメッセージ -->
            <div class="d-flex justify-content-end mb-3">
              <div>
                <div class="text-end small text-muted">既読 <%= msg.readBy.length %>｜<%= msg.createdAt.toLocaleTimeString() %></div>
                <div class="bg-primary text-white rounded px-3 py-2 shadow-sm">
                  <%= msg.message %>
                </div>
              </div>
              <div class="d-flex flex-column align-items-center ms-2">
                <img src="<%= currentUser.avatar %>" alt="avatar" class="rounded-circle" style="width: 40px; height: 40px;">
                <form action="/gchat/<%= chat._id %>/message/<%= msg._id %>?_method=DELETE" method="POST" class="mt-1">
                  <button type="submit" class="btn btn-sm btn-outline-danger btn-sm px-2 py-0">削除</button>
                </form>
              </div>
            </div>
          <% } else { %>
            <!-- 相手のメッセージ -->
            <div class="d-flex justify-content-start mb-3">
              <img src="<%= msg.sender.avatar %>" alt="avatar" class="rounded-circle me-2" style="width: 40px; height: 40px;">
              <div>
                <div class="fw-bold"><%= msg.sender.displayname || msg.sender.username %></div>
                <div class="small text-muted"><%= msg.createdAt.toLocaleTimeString() %></div>
                <div class="bg-white border rounded px-3 py-2 shadow-sm">
                  <%= msg.message %>
                </div>
              </div>
            </div>
          <% } %>
        <% }); %>
      </div>

      <form action="/gchat/<%= chat._id %>/send" method="POST" id="message-form" class="border-top pt-3">
        <div class="input-group">
          <input type="text" name="text" id="message-input" class="form-control" placeholder="メッセージを入力..." required>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // チャットボックスを最下部までスクロール
  const chatBox = document.getElementById('chat-box');
  chatBox.scrollTop = chatBox.scrollHeight;

  // 入力エリアでEnterキーで送信（Shift+Enterで改行）
  const messageForm = document.getElementById('message-form');
  const messageInput = document.getElementById('message-input');

  let isComposing = false;

  messageInput.addEventListener('compositionstart', () => {
    isComposing = true;
  });

  messageInput.addEventListener('compositionend', () => {
    isComposing = false;
  });

  messageInput.addEventListener('keydown', function (e) {
    if (e.key === 'Enter' && !e.shiftKey && !isComposing) {
      e.preventDefault(); // Enterキーでは送信せず、ボタンを使うように
    }
  });

  messageForm.addEventListener('submit', function (e) {
    const message = messageInput.value.trim();
    if (!message) {
      e.preventDefault(); // 空の送信を防止
    }
  });
</script>
