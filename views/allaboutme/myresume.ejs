<% layout('layouts/boilerplate') %>
<% page = 'myresume' %>

<div class="text-end mb-2">
  <a href="https://colts-wish-krs.craft.me/UJ4Y7muYdOwQlH/b/B38889F6-6A53-4529-9300-8798C8634ECE/My-%E5%B1%A5%E6%AD%B4%E6%9B%B8"
    target="_blank" rel="noopener"
    class="badge bg-success text-white text-decoration-none p-2">
    ガイド
  </a>
</div>

<%- include('../partials/resume_tabs_nav') %>

<style>
  table.table-bordered td, table.table-bordered th {
    border: 1px solid #ccc !important;
  }
  tbody tr:nth-child(odd),
  tbody tr:nth-child(even) {
    background-color: transparent !important;
  }
</style>

<div class="container mt-4">
<% if (resume) { %>
  <h2 class="text-center mb-4"> 履歴書</h2>
    <table class="table table-bordered" style="border-collapse: collapse;">
        <tbody>
        <tr>
            <td style="width: 15%;"><strong>氏名</strong></td>
            <td style="width: 35%;"><%= resume?.last_name || '' %> <%= resume?.first_name || '' %></td>
            <td rowspan="4" colspan="2" class="text-center align-middle" style="width: 30%;">
            <% if (resume?.photoBase64 || resume?.photo_url) { %>
                <img src="<%= resume.photoBase64 || resume.photo_url %>" class="img-fluid" alt="写真" style="max-width: 150px; max-height: 200px;">
            <% } else { %>
                写真未登録
            <% } %>
            </td>
        </tr>
        <tr>
            <td><strong>ふりがな</strong></td>
            <td><%= resume?.last_name_kana || '' %> <%= resume?.first_name_kana || '' %></td>
        </tr>
        <tr>
            <td><strong>メール</strong></td>
            <td><%= user?.email || '' %></td>
        </tr>
        <tr>
            <td><strong>生年月日・性別</strong></td>
            <td>
            生年月日：<%= user?.birth_date ? user.birth_date.toISOString().substring(0, 10) : '' %><br>
            性別：<%= user?.sex || '' %>
            </td>
        </tr>
        <tr>
            <td><strong>現住所</strong></td>
            <td colspan="3">
            〒<%= resume?.zip || '' %><br>
            <%= resume?.prefecture || '' %><%= resume?.city || '' %><%= resume?.address_detail || '' %>
            </td>
        </tr>
        <tr>
            <td><strong>電話番号</strong></td>
            <td colspan="3">
            自宅: <%= resume?.home_phone || '－' %><br>
            携帯: <%= resume?.mobile_phone || '－' %>
            </td>
        </tr>
        </tbody>
    </table>
  
    <!-- 学歴・職歴 Section -->
    <% if (educationEntries && educationEntries.length > 0) { %>
      <table class="table table-bordered" style="border-collapse: collapse;">
        <thead class="table-dark">
          <tr>
            <th colspan="3" class="text-center">学歴</th>
          </tr>
        </thead>
        <tbody>
          <% educationEntries.forEach(entry => { %>
            <tr>
              <td style="width: 20%;">
                <%= entry.from_date_str %>〜<%= entry.end_date_str %>
              </td>
              <td style="width: 70%;">
                <%= entry.school_type %>　<strong><%= entry.school_name %></strong>
              </td>
              <td style="width: 10%;" class="text-center">
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#eduModal_<%= entry._id %>">詳細</button>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>

      <% educationEntries.forEach(entry => { %>
        <div class="modal fade" id="eduModal_<%= entry._id %>" tabindex="-1" aria-labelledby="eduModalLabel_<%= entry._id %>" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="eduModalLabel_<%= entry._id %>"><%= entry.school_name %> 詳細</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
              </div>
              <div class="modal-body">
                <p><strong>期間：</strong><%= entry.from_date_str %>〜<%= entry.end_date_str %></p>
                <p><strong>区分：</strong><%= entry.school_type %></p>
                <p><strong>学校名：</strong><%= entry.school_name %></p>
                <p><strong>学んだこと：</strong><%= entry.detail %></p>
              </div>
            </div>
          </div>
        </div>
      <% }) %>
    <% } %>

    <!-- 職歴の表示 -->
    <% if (careerEntries && careerEntries.length > 0) { %>
      <table class="table table-bordered" style="border-collapse: collapse;">
        <thead class="table-dark">
          <tr>
            <th colspan="3" class="text-center">職歴</th>
          </tr>
        </thead>
        <tbody>
          <% careerEntries.forEach(entry => { %>
            <tr>
              <td style="width: 20%;">
                <%= entry.from_date_str %>〜<%= entry.end_date_str %>
              </td>
              <td style="width: 70%;">
                <%= entry.company %><br>
                <%= entry.department %>　<%= entry.position %>
              </td>
              <td style="width: 10%;" class="text-center">
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#careerModal_<%= entry._id %>">詳細</button>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>

      <% careerEntries.forEach(entry => { %>
        <div class="modal fade" id="careerModal_<%= entry._id %>" tabindex="-1" aria-labelledby="careerModalLabel_<%= entry._id %>" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="careerModalLabel_<%= entry._id %>"><%= entry.company %> 詳細</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
              </div>
              <div class="modal-body">
                <p><strong>期間：</strong><%= entry.from_date_str %>〜<%= entry.end_date_str %></p>
                <p><strong>部署：</strong><%= entry.department %></p>
                <p><strong>役職：</strong><%= entry.position %></p>
                <p><strong>職務内容：</strong><%- entry.summary?.replace(/\n/g, '<br>') %></p>
                <p><strong>職務アピールポイント：</strong><%- entry.details?.replace(/\n/g, '<br>') %></p>
              </div>
            </div>
          </div>
        </div>
      <% }) %>
    <% } %>

    <table>
        <tbody>
        <tr>
            <td colspan="4" style="border: 1px solid #ccc;">
            <div style="background-color: #f0f0f0; text-align: center; font-weight: bold;">自己PR</div>
            <div style="white-space: pre-line;"><%- resume?.self_promotion || '' %></div>
            </td>
        </tr>
        <tr>
            <td colspan="4" style="border: 1px solid #ccc;">
            <div style="background-color: #f0f0f0; text-align: center; font-weight: bold;">資格・特技</div>
            <div style="white-space: pre-line;"><%- resume?.skills || '' %></div>
            </td>
        </tr>
        <tr>
            <td colspan="4" style="border: 1px solid #ccc;">
            <div style="background-color: #f0f0f0; text-align: center; font-weight: bold;">活かせる経験・知識・技術等</div>
            <div style="white-space: pre-line;"><%- resume?.experience || '' %></div>
            </td>
        </tr>
        </tbody>
</table>
<hr>
  <div class="text-end mt-4">
    <a href="/resume/resume/view/<%= resume._id %>" target="_blank" class="btn btn-primary me-2">
      <i class="fa-solid fa-eye"></i> 履歴書（印刷用）
    </a>
    <form id="publishForm" action="/resume/myresume/publish/<%= resume._id %>" method="POST" class="d-inline <%= resume?.isrPublished ? 'd-none' : '' %>">
      <button type="submit" class="btn btn-warning">
        <i class="fa-solid fa-globe"></i> 公開ページを作成
      </button>
    </form>
    <form id="unpublishForm" action="/resume/myresume/unpublish/<%= resume._id %>" method="POST" class="d-inline <%= resume?.isrPublished ? '' : 'd-none' %>">
      <button type="submit" class="btn btn-secondary">
        <i class="fa-solid fa-eye-slash"></i> 公開を停止する
      </button>
    </form>
    <div id="shareMessage" class="alert alert-success mt-3 <%= resume?.isrPublished ? '' : 'd-none' %>" role="alert">
      公開ページを作成しました。このURLを共有してください：<br>
      <a id="publicUrl" href="#" target="_blank"></a>
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const publicUrl = document.getElementById('publicUrl');
          if (publicUrl) {
            const resumeId = '<%= resume._id %>';
            const fullUrl = location.origin + '/resume/public/myresume/' + resumeId;
            publicUrl.href = fullUrl;
            publicUrl.textContent = fullUrl;
          }
        });
      </script>
    </div>

    <script>
      document.getElementById('publishForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        const form = event.target;
        const action = form.action;

        const unpublishButton = form.querySelector('button');
        unpublishButton.disabled = true;

        try {
          const response = await fetch(action, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          });

          if (response.ok) {
            const url = '/resume/public/myresume/<%= resume._id %>';
            const fullUrl = location.origin + url;
            const msgDiv = document.getElementById('shareMessage');
            const link = document.getElementById('publicUrl');

            link.href = fullUrl;
            link.textContent = fullUrl;
            msgDiv.classList.remove('d-none');

            // Switch button visibility
            form.classList.add('d-none');
            const unpublishForm = document.getElementById('unpublishForm');
            unpublishForm.classList.remove('d-none');

            // Change button text
            const unpublishButton = unpublishForm.querySelector('button');
            if (unpublishButton) {
              unpublishButton.innerHTML = '<i class="fa-solid fa-eye-slash"></i> 公開を停止する';
            }
          } else {
            alert('公開処理に失敗しました');
          }
        } catch (err) {
          console.error(err);
          alert('エラーが発生しました');
        }
      });

      document.getElementById('unpublishForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        const form = event.target;
        const unpublishButton = form.querySelector('button');
        const action = form.action;

        try {
          const response = await fetch(action, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          });

          if (response.ok) {
            form.classList.add('d-none');
            const publishForm = document.getElementById('publishForm');
            publishForm.classList.remove('d-none');
            publishForm.querySelector('button').disabled = false;

            // Reset the button text for "公開ページを作成"
            const publishButton = publishForm.querySelector('button');
            if (publishButton) {
              publishButton.innerHTML = '<i class="fa-solid fa-globe"></i> 公開ページを作成';
            }
            document.getElementById('shareMessage').classList.add('d-none');

            unpublishButton.disabled = false;
            unpublishButton.innerHTML = '<i class="fa-solid fa-eye-slash"></i> 公開を停止する';
          } else {
            alert('公開停止処理に失敗しました');
            unpublishButton.disabled = false;
          }
        } catch (err) {
          console.error(err);
          alert('エラーが発生しました');
          unpublishButton.disabled = false;
        }
      });
    </script>
  </div>
</div>
<% } else { %>
  <div class="alert alert-warning text-center">
    まだ履歴書が登録されていません。<a href="/resume/edit">設定画面</a>で登録してください。
  </div>
<% } %>