<% layout('layouts/boilerplate') %>
<% page = 'mycv' %>

<div class="text-end mb-2">
  <a href="https://colts-wish-krs.craft.me/UJ4Y7muYdOwQlH/b/B38889F6-6A53-4529-9300-8798C8634ECE/My-%E5%B1%A5%E6%AD%B4%E6%9B%B8"
    target="_blank" rel="noopener"
    class="badge bg-success text-white text-decoration-none p-2">
    ガイド
  </a>
</div>

<%- include('../partials/resume_tabs_nav') %>

<div class="container mt-4">
  <% if (resume) { %>
  <h2 class="text-center mb-4"> 職務履歴書</h2>
  <div class="d-flex justify-content-end">
    <h6 class="text-end"><%= resume?.last_name || '' %> <%= resume?.first_name || '' %>（ <%= resume?.last_name_kana || '' %> <%= resume?.first_name_kana || '' %> ）</h6>
  </div>

  <div class="mt-2">
    <h5 class="section-title">職歴要約</h5>
    <p><%- resume?.summary?.replace(/\n/g, '<br>') %></p>
  </div>

  <div class="mt-4">
    <h5 class="section-title">職務経歴</h5>
    <% historyEntries.forEach(entry => { %>
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong><%= entry.company %> <%= entry.department %></strong><small><%= entry.from_date_str %>〜<%= entry.end_date_str %> (<%= entry.age_range %>)</small>
          <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#detailModal_<%= entry._id %>">詳細</button>
        </div>
        <div class="card-body">
          <p><strong>役職：</strong><%= entry.position %></p>
          <p><strong>職務内容：</strong><%- entry.summary?.replace(/\n/g, '<br>') %></p>
        </div>
      </div>

      <!-- モーダル -->
      <div class="modal fade" id="detailModal_<%= entry._id %>" tabindex="-1" aria-labelledby="modalLabel_<%= entry._id %>" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="modalLabel_<%= entry._id %>">詳細情報</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
            </div>
            <div class="modal-body">
              <p><strong>会社名：</strong><%= entry.company %></p>
              <p><strong>部署名：</strong><%= entry.department %><br><%= entry.from_date_str %> 〜 <%= entry.end_date_str %> (<%= entry.age_range %>)</p>
              <p><strong>役職：</strong><%= entry.position %></p>
                <hr>
              <p><strong>職務内容：</strong></p>
              <p><%- entry.summary?.replace(/\n/g, '<br>') %></p>
              <p><strong>職務アピールポイント：</strong></p>
              <p><%- entry.details?.replace(/\n/g, '<br>') %></p>
            </div>
          </div>
        </div>
      </div>
    <% }) %>
  </div>

  <div class="mt-4">
    <h5 class="section-title">【資格・特技】</h5>
    <p><%- resume?.skills?.replace(/\n/g, '<br>') %></p>
  </div>

  <div class="mt-4">
    <h5 class="section-title">【活かせる経験・知識・技術等】</h5>
    <p><%- resume?.experience?.replace(/\n/g, '<br>') %></p>
  </div>

  <div class="mt-4">
    <h5 class="section-title">【自己PR】</h5>
    <p><%- resume?.self_promotion?.replace(/\n/g, '<br>') %></p>
  </div>
</div>
</div>
<hr>
  <div class="text-end mt-4">
    <a href="/resume/mycv/view/<%= resume._id %>" target="_blank" class="btn btn-primary me-2">
      <i class="fa-solid fa-eye"></i> 職務履歴書（印刷用）
    </a>
    <!-- <a href="/allaboutme/mycv/view/<%= resume._id %>?format=pdf" class="btn btn-danger" target="_blank">
      <i class="fa-solid fa-file-pdf"></i> PDFダウンロード
    </a> -->
    <form id="publishForm" action="/resume/mycv/publish/<%= resume._id %>" method="POST" class="d-inline <%= resume.isPublished ? 'd-none' : '' %>">
      <button type="submit" class="btn btn-warning" id="publishButton">
        <i class="fa-solid fa-globe"></i> <span id="publishButtonText">公開用ページを作成</span>
      </button>
    </form>
    <form id="unpublishForm" action="/resume/mycv/unpublish/<%= resume._id %>" method="POST" class="d-inline <%= resume.isPublished ? '' : 'd-none' %>">
      <button type="submit" class="btn btn-secondary" id="unpublishButton">
        <i class="fa-solid fa-eye-slash"></i> <span id="unpublishButtonText">公開を停止する</span>
      </button>
    </form>
    <div id="shareMessage" class="alert alert-success mt-3 <%= resume.isPublished ? '' : 'd-none' %>" role="alert">
      公開ページを作成しました。このURLを共有してください：<br>
      <a id="publicUrl" href="<%= `${process.env.BASE_URL || ''}/resume/public/mycv/${resume._id}` %>" target="_blank">
        <%= `${process.env.BASE_URL || ''}/resume/public/mycv/${resume._id}` %>
      </a>
    </div>
  </div>
  <% } else { %>
  <div class="alert alert-warning text-center">
    まだ情報が登録されていません。<a href="/resume/edit">設定画面</a>で登録してください。
  </div>
<% } %>
<% if (resume) { %>
<script>
  document.getElementById('publishForm').addEventListener('submit', async function(event) {
    event.preventDefault();
    const form = event.target;
    const action = form.action;

    const publishButton = form.querySelector('button');
    publishButton.disabled = true;

    try {
      const response = await fetch(action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        }
      });

      if (response.ok) {
        const url = '/resume/public/mycv/<%= resume._id %>';
        const fullUrl = location.origin + url;
        const msgDiv = document.getElementById('shareMessage');
        const link = document.getElementById('publicUrl');

        link.href = fullUrl;
        link.textContent = fullUrl;
        msgDiv.classList.remove('d-none');

        form.classList.add('d-none');
        const unpublishForm = document.getElementById('unpublishForm');
        unpublishForm.classList.remove('d-none');

        const unpublishButton = unpublishForm.querySelector('button');
        if (unpublishButton) {
          unpublishButton.innerHTML = '<i class="fa-solid fa-eye-slash"></i> 公開を停止する';
        }
      } else {
        alert('公開処理に失敗しました');
        publishButton.disabled = false;
      }
    } catch (err) {
      console.error(err);
      alert('エラーが発生しました');
      publishButton.disabled = false;
    }
  });

  document.getElementById('unpublishForm').addEventListener('submit', async function(event) {
    event.preventDefault();
    const form = event.target;
    const unpublishButton = form.querySelector('button');
    const action = form.action;

    try {
      const response = await fetch(action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        }
      });

      if (response.ok) {
        form.classList.add('d-none');
        const publishForm = document.getElementById('publishForm');
        publishForm.classList.remove('d-none');
        publishForm.querySelector('button').disabled = false;

        const publishButton = publishForm.querySelector('button');
        if (publishButton) {
          publishButton.innerHTML = '<i class="fa-solid fa-globe"></i> 公開用ページを作成';
        }
        document.getElementById('shareMessage').classList.add('d-none');

        unpublishButton.disabled = false;
        unpublishButton.innerHTML = '<i class="fa-solid fa-eye-slash"></i> 公開を停止する';
      } else {
        alert('公開停止処理に失敗しました');
        unpublishButton.disabled = false;
      }
    } catch (err) {
      console.error(err);
      alert('エラーが発生しました');
      unpublishButton.disabled = false;
    }
  });
</script>
<% } %>
