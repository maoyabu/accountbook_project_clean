<% layout('layouts/boilerplate') %>
<% page = 'relationdetail' %>
<%- include('../partials/allaboutme_tabs_nav') %>

<div class="container mt-4">
    <div class="text-end mb-2">
    <a href="https://colts-wish-krs.craft.me/UJ4Y7muYdOwQlH/b/1B0724C9-975D-46F3-95CF-1D44AAC5CF48/My-Relation"
      target="_blank" rel="noopener"
      class="badge bg-success text-white text-decoration-none p-2">
      „Ç¨„Ç§„Éâ
    </a>
  </div>
  <div class="border rounded p-3 mb-3">
    <h3><i class="fa-solid fa-people-group"></i> My relation</h3>
    <hr>
    <form action="/relation/<%= relation._id %>?_method=PUT" method="POST">
      <div class="mb-3 d-flex align-items-center gap-3">
        <% if (relation.relationUserId?.avatar) { %>
          <img src="<%= relation.relationUserId.avatar %>" alt="avatar" class="rounded-circle" style="width: 80px; height: 80px;">
        <% } else { %>
          <div class="text-muted">„Ç¢„Éê„Çø„ÉºÊú™Ë®≠ÂÆö</div>
        <% } %>
        <span class="badge bg-primary fs-6">
          Relation UserÔºö<%= relation.relationUserId?.displayname || relation.relationUserId?.username %> „Åï„Çì
        </span>
      </div>
      <div class="mb-3">
        <label for="relationship" class="form-label">Èñ¢‰øÇÊÄß</label>
        <select name="relationship" id="relationship" class="form-select" required>
          <% relationshipOptions.forEach(opt => { %>
            <option value="<%= opt %>" <%= relation.relationship === opt ? 'selected' : '' %>><%= opt %></option>
          <% }) %>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">„Åì„Çå„Åæ„Åß„ÅÆ„Éé„Éº„Éà</label>
        <% if (relation.relationNote && relation.relationNote.length > 0) { %>
          <ul class="list-group mb-2">
            <% relation.relationNote.forEach(note => { %>
              <li class="list-group-item"><%= note %></li>
            <% }) %>
          </ul>
        <% } else { %>
          <p class="text-muted">„Éé„Éº„Éà„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
        <% } %>

        <label for="relationNote" class="form-label">„Éé„Éº„Éà„ÇíËøΩÂä†</label>
        <textarea name="relationNote" id="relationNote" class="form-control" rows="3" placeholder="Êñ∞„Åó„ÅÑ„Éé„Éº„Éà„ÇíÂÖ•Âäõ"></textarea>
      </div>
      <div class="mb-3">
        <label class="form-label">„Åì„ÅÆ„É¶„Éº„Ç∂„Éº„Å´ÂÖ±Êúâ„Åô„ÇãÊÉÖÂ†±</label><br>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="sharedTypes" value="wantolist"
            <%= sharedTypes.includes('wantolist') ? 'checked' : '' %> >
          <label class="form-check-label">„Éû„Ç§„É™„Çπ„Éà</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="sharedTypes" value="diary"
            <%= sharedTypes.includes('diary') ? 'checked' : '' %> >
          <label class="form-check-label">Êó•Ë®ò</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="sharedTypes" value="history"
            <%= sharedTypes.includes('history') ? 'checked' : '' %> >
          <label class="form-check-label">MyHistory</label>
        </div>
      </div>
      <hr>
      <button type="submit" class="btn btn-primary">‰øùÂ≠ò</button>
      <a href="/relation" class="btn btn-secondary">Êàª„Çã</a>
    </form>
  </div>
  <div class="border rounded p-3 mb-3">
    <span class="badge bg-success fs-6"><i class="fa-solid fa-circle-info"></i> ÂÖ±Êúâ„Åï„Çå„Å¶„ÅÑ„ÇãÊÉÖÂ†±</span>
    <div class="mt-2">
      <p class="form-control-plaintext"><strong>Ë™ïÁîüÊó•Ôºö</strong><%= relation.relationUserId?.birth_date ? relation.relationUserId.birth_date.toLocaleDateString() : 'Êú™Ë®≠ÂÆö' %></p>
      <p class="form-control-plaintext"><strong>ÊÄßÂà•Ôºö</strong><%= relation.relationUserId?.sex || 'Êú™Ë®≠ÂÆö' %></p>
      <p class="form-control-plaintext"><strong>Ë°ÄÊ∂≤ÂûãÔºö</strong>
        <% if (relation.relationUserId?.blood) { %>
          <%= relation.relationUserId.blood %><%= relation.relationUserId.rh || '' %>
        <% } else { %>
          Êú™Ë®≠ÂÆö
        <% } %>
      </p>
      <div class="mb-3">
        <label class="form-label">
          <i class="fa-solid fa-share-nodes text-success"></i> „ÅÇ„Å™„Åü„Å´ÂÖ±Êúâ„Åó„Å¶„ÅÑ„ÇãÊÉÖÂ†±
        </label>
        <ul class="list-group">
          <% const typeMap = { wantolist: '„Éû„Ç§„É™„Çπ„Éà', diary: 'Êó•Ë®ò', history: 'MyHistory' }; %>
          <% if (sharedTypesToMe && sharedTypesToMe.length > 0) { %>
            <% sharedTypesToMe.forEach(type => { %>
              <% const link = type === 'wantolist'
                ? `/allaboutme/wantolist?userId=${relation.relationUserId._id}&fromRelation=1`
                : type === 'diary'
                ? `/allaboutme/eventcal?userId=${relation.relationUserId._id}&fromRelation=1`
                : type === 'history'
                ? `/history/list?user=${relation.relationUserId._id}&fromRelation=1`
                : '#'; %>
              <li class="list-group-item py-2">
                üìå <a href="<%= link %>"><%= typeMap[type] || type %></a>
              </li>
            <% }) %>
          <% } else { %>
            <li class="list-group-item text-muted text-center">ÂÖ±Êúâ„Åï„Çå„Å¶„ÅÑ„ÇãÊÉÖÂ†±„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</li>
          <% } %>
        </ul>

        <% if (sharedTypesToMe.includes('history') && sharedActiveHistories && sharedActiveHistories.length > 0) { %>
          <div class="mt-4">
            <div class="col-12">
              <h5><i class="fas fa-clock"></i> Áõ∏Êâã„ÅÆMyHistoryÔºàÂÖ¨Èñã‰∏≠Ôºâ</h5>
            </div>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
              <% sharedActiveHistories.forEach((history, idx) => { %>
                <div class="col">
                  <div data-bs-toggle="modal" data-bs-target="#historyModal<%= idx %>" style="cursor:pointer;">
                    <div class="card h-100 shadow-sm">
                      <div class="card-header text-white" style="background-color: <%= history.category?.color || '#0d6efd' %>;">
                        <strong><%= history.category?.name || '„Ç´„ÉÜ„Ç¥„É™„ÉºÊú™Ë®≠ÂÆö' %></strong>
                      </div>
                      <div class="card-body" style="height: 300px; overflow: hidden;">
                        <% if (history.photos && history.photos.length > 0) { %>
                          <div class="mb-3 text-center">
                            <img src="<%= typeof history.photos[0] === 'string' ? history.photos[0] : history.photos[0].url %>" alt="Â±•Ê≠¥ÁîªÂÉè" class="img-fluid rounded" style="max-height: 200px; object-fit: cover;">
                          </div>
                        <% } %>
                        <ul class="mb-2">
                          <% for (const [key, value] of Object.entries(history.data || {})) {
                               if (value && value.trim() !== '') {
                                 const fieldDef = history.category?.fields && history.category.fields.find(f => f.name === key);
                                 const isTextarea = fieldDef?.type === 'textarea';
                          %>
                            <% if (isTextarea) { %>
                              <li class="content-preview" style="max-height: 7.5em; overflow: hidden; position: relative;">
                                <strong><%= key %>:</strong>
                                <%- value.replace(/\n/g, '<br>') %>
                              </li>
                            <% } else { %>
                              <li><strong><%= key %>:</strong> <%= value %></li>
                            <% } %>
                          <% }} %>
                        </ul>
                        <% if (history.url) { %>
                          <p><a href="<%= history.url %>" target="_blank" rel="noopener">üîó Èñ¢ÈÄ£„É™„É≥„ÇØ</a></p>
                        <% } %>
                        <% if (history.content) { %>
                          <div>
                            <strong>„Ç≥„É°„É≥„Éà</strong><br>
                            <p class="content-preview" style="max-height: 7.5em; overflow: hidden; position: relative;">
                              <%- history.content.replace(/\n/g, '<br>') %>
                              <span class="read-more text-primary" style="cursor:pointer;" data-bs-toggle="modal" data-bs-target="#historyModal<%= idx %>">...„ÇÇ„Å£„Å®Ë¶ã„Çã</span>
                            </p>
                          </div>
                        <% } %>
                        <p><strong>From - To:</strong>
                          <%= history.from_date ? new Date(history.from_date).toLocaleDateString('ja-JP') : '‚Äî' %> „Äú
                          <%= history.end_date ? new Date(history.end_date).toLocaleDateString('ja-JP') : '‚Äî' %>
                        </p>
                        <p><input class="form-check-input me-1" type="checkbox" disabled <%= history.share ? 'checked' : '' %>> ÂÖ±Êúâ„Åô„Çã</p>
                      </div>
                    </div>
                  </div>

                  <!-- Modal -->
                  <div class="modal fade" id="historyModal<%= idx %>" tabindex="-1" aria-labelledby="historyModalLabel<%= idx %>" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-scrollable">
                      <div class="modal-content">
                        <div class="modal-header" style="background-color: <%= history.category?.color || '#0d6efd' %>;">
                          <h5 class="modal-title text-white" id="historyModalLabel<%= idx %>"><%= history.category?.name || '„Ç´„ÉÜ„Ç¥„É™„ÉºÊú™Ë®≠ÂÆö' %></h5>
                          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Èñâ„Åò„Çã"></button>
                        </div>
                        <div class="modal-body">
                          <% if (history.photos && history.photos.length > 0) { %>
                            <div class="mb-3 text-center">
                              <% history.photos.forEach(photo => { %>
                                <img src="<%= typeof photo === 'string' ? photo : photo.url %>" class="img-fluid rounded mb-2" style="max-height: 200px; object-fit: cover;">
                              <% }) %>
                            </div>
                          <% } %>
                          <ul class="mb-3">
                            <% for (const [key, value] of Object.entries(history.data || {})) {
                                 if (value && value.trim() !== '') { %>
                              <li><strong><%= key %>:</strong> <%- value.replace(/\n/g, '<br>') %></li>
                            <% }} %>
                          </ul>
                          <% if (history.url) { %>
                            <p><strong>„É™„É≥„ÇØ:</strong> <a href="<%= history.url %>" target="_blank" rel="noopener"><%= history.url %></a></p>
                          <% } %>
                          <% if (history.content) { %>
                            <p><strong>„Ç≥„É°„É≥„Éà:</strong><br><%- history.content.replace(/\n/g, '<br>') %></p>
                          <% } %>
                          <p><strong>From - To:</strong>
                            <%= history.from_date ? new Date(history.from_date).toLocaleDateString('ja-JP') : '‚Äî' %> „Äú
                            <%= history.end_date ? new Date(history.end_date).toLocaleDateString('ja-JP') : '‚Äî' %></p>
                          <p><input class="form-check-input me-1" type="checkbox" disabled <%= history.share ? 'checked' : '' %>> ÂÖ±Êúâ„Åô„Çã</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              <% }) %>
            </div>
          </div>
        <% } %>
      </div>
    </div>
  </div>

</div>